## GCD å†…å®¹ç›¸å…³Demo, Swiftç‰ˆ
Swift3.0ç›¸å…³ä»£ç å·²åœ¨githubä¸Šæ›´æ–°ã€‚ä¹‹å‰å…³äºiOSå¼€å‘å¤šçº¿ç¨‹çš„å†…å®¹å‘å¸ƒè¿‡ä¸€ç¯‡åšå®¢ï¼Œå…¶ä¸­ä»‹ç»äº†NSThreadã€æ“ä½œé˜Ÿåˆ—ä»¥åŠGCDï¼Œä»‹ç»çš„ä¸å¤Ÿæ·±å…¥ã€‚ä»Šå¤©å°±ä»¥GCDä¸ºä¸»é¢˜æ¥å…¨é¢çš„æ€»ç»“ä¸€ä¸‹GCDçš„ä½¿ç”¨æ–¹å¼ã€‚GCDçš„å†å²ä»¥åŠå¥½å¤„åœ¨æ­¤å°±ä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ã€‚æœ¬ç¯‡åšå®¢ä¼šé€šè¿‡ä¸€ç³»åˆ—çš„å®ä¾‹æ¥å¥½å¥½çš„æ€»ç»“ä¸€ä¸‹GCDã€‚GCDåœ¨iOSå¼€å‘ä¸­è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œä½¿ç”¨åœºæ™¯ä¹Ÿæ˜¯éå¸¸å¤šçš„ï¼Œå¤„ç†ä¸€äº›æ¯”è¾ƒè€—æ—¶çš„ä»»åŠ¡æ—¶åŸºæœ¬ä¸Šéƒ½ä¼šä½¿ç”¨åˆ°GCD, åœ¨ä½¿ç”¨æ˜¯æˆ‘ä»¬ä¹Ÿè¦ä¸»è¦ä¸€äº›çº¿ç¨‹å®‰å…¨ä¹Ÿæ­»é”çš„ä¸œè¥¿ã€‚

æœ¬ç¯‡åšå®¢ä¸­å¯¹iOSä¸­çš„GCDæŠ€æœ¯è¿›è¡Œäº†è¾ƒä¸ºå…¨é¢çš„æ€»ç»“ï¼Œä¸‹æ–¹æ¨¡æ‹Ÿå™¨çš„æˆªå›¾å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„å†…å®¹ï¼Œéƒ½æ˜¯å…³äºGCDçš„ã€‚ä¸‹æ–¹è§†å›¾æ§åˆ¶å™¨ä¸­æ¯ç‚¹å‡»ä¸€ä¸ªButtonéƒ½ä¼šä½¿ç”¨GCDçš„ç›¸å…³æŠ€æœ¯æ¥æ‰§è¡Œä¸åŒçš„å†…å®¹ã€‚æœ¬ç¯‡åšå®¢ä¼šå¯¹ä½¿ç”¨åˆ°çš„æ¯ä¸ªæŠ€æœ¯ç‚¹è¿›è¡Œè¯¦ç»†çš„è®²è§£ã€‚åœ¨è®²è§£æ—¶ï¼Œä¸ºäº†æ˜“äºç†è§£ï¼Œæˆ‘ä»¬è¿˜ä¼šç»™å‡ºåŸç†å›¾ï¼Œè¿™äº›åŸç†å›¾éƒ½æ˜¯æ ¹æ®æœ¬ç¯‡åšå®¢ä¸­çš„å®ä¾‹è¿›è¡Œåˆ›ä½œçš„ï¼Œåœ¨å…¶ä»–åœ°æ–¹å¯è§ä¸ç€ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160515214503648-186877899.png)

ä¸Šé¢æ¯ä¸ªæŒ‰é’®éƒ½å¯¹åº”ç€ä¸€å¨å¨çš„ä»£ç ï¼Œä¸Šé¢è¿™ä¸ªæˆªå›¾ç®—æ˜¯æˆ‘ä»¬æœ¬ç¯‡åšå®¢çš„ä¸€ä¸ªï¼Œä¸‹é¢æˆ‘ä»¬å°†ä¼šå¯¹æ¯å¨ä»£ç è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚é€šè¿‡è¿™äº›ä»‹ç»ï¼Œä½ åº”è¯¥å¯¹GCDæœ‰äº†æ›´å…¨é¢è€Œä¸”æ›´è¯¦ç»†çš„äº†è§£ã€‚å»ºè®®å‚è€ƒç€ä¸‹æ–¹çš„ä»‹ç»ï¼Œç„¶åè‡ªå·±åŠ¨æ‰‹å»ä¾¿å®ç°ä»£ç ï¼Œè¿™æ ·æ•ˆæœæ˜¯ç°å¸¸çš„å¥½çš„ã€‚æœ¬ç¯‡åšå®¢ä¸­çš„æ‰€æœ‰ä»£ç éƒ½ä¼šåœ¨githubä¸Šè¿›è¡Œåˆ†äº«ï¼Œæœ¬ç¯‡åšå®¢çš„åæ–¹ä¼šç»™å‡ºgithubåˆ†äº«åœ°å€ã€‚å…¶å®æœ¬ç¯‡åšå®¢å¯ä»¥ä½œä¸ºä½ çš„GCDå‚è€ƒæ‰‹å†Œï¼Œè™½ç„¶æœ¬ç¯‡åšå®¢æ²¡æœ‰å›Šæ‹¬æ‰€æœ‰GCDçš„ä¸œè¥¿ï¼Œä½†æ˜¯å¹³æ—¶ç»å¸¸ä½¿ç”¨çš„éƒ¨åˆ†è¿˜æ˜¯æœ‰çš„ã€‚åºŸè¯å°‘è¯´ï¼Œè¿›å…¥ä»Šå¤©åšå®¢çš„ä¸»é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸€ä¸ªButtonæ¥ç€ä¸€ä¸ªButtonçš„ä»‹ç»ã€‚

## ä¸€ã€å¸¸ç”¨GCDæ–¹æ³•çš„å°è£…

ä¸ºäº†ä¾¿äºå®ä¾‹çš„å®ç°ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹ä¸€äº›å¸¸ç”¨çš„GCDæ–¹æ³•è¿›è¡Œå°è£…å’Œæå–ã€‚è¯¥éƒ¨åˆ†ç®—æ˜¯ä¸ºä¸‹æ–¹çš„å…·ä½“å®ä¾‹åšå‡†å¤‡çš„ï¼Œæœ¬éƒ¨åˆ†å°è£…äº†ä¸€äº›ä¸‹é¢ç¤ºä¾‹æ‰€å…¬ç”¨çš„æ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€æ­¥çš„å¯¹æ¯ä¸ªæå–çš„å‡½æ•°è¿›è¡Œä»‹ç»ï¼Œä¸ºä¸‹æ–¹ç¤ºä¾‹çš„å®ç°åšå‡†å¤‡ã€‚åœ¨å°è£…æ–¹æ³•ä¹‹å‰ï¼Œè¦è¯´æ˜ä¸€ç‚¹çš„æ˜¯åœ¨GCDä¸­æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æ”¾åœ¨é˜Ÿåˆ—ä¸­åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè¦æ˜ç™½ä¸€ç‚¹å°±æ˜¯æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æ”¾åœ¨é˜Ÿåˆ—ä¸­çš„Blockä¸­ï¼Œç„¶åBlockå†åœ¨ç›¸åº”çš„çº¿ç¨‹ä¸­å®Œæˆæˆ‘ä»¬çš„ä»»åŠ¡ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ä¸‹æ–¹é˜Ÿåˆ—ä¸­å­˜å…¥äº†ä¸‰ä¸ªBlockï¼Œæ¯ä¸ªBlockå¯¹åº”ç€ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡ä¼šæ ¹æ®é˜Ÿåˆ—çš„ç‰¹æ€§å·²ç»æ‰§è¡Œæ–¹å¼è¢«æ”¾åˆ°ç›¸åº”çš„çº¿ç¨‹ä¸­æ¥æ‰§è¡Œã€‚é˜Ÿåˆ—å¯åˆ†ä¸ºå¹¶è¡Œé˜Ÿåˆ—ï¼ˆConcurrent Qeueuï¼‰å’Œä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Queueï¼‰ï¼Œé˜Ÿåˆ—å¯ä»¥è¿›è¡ŒåŒæ­¥æ‰§è¡Œ(Synchronize)ä»¥åŠå¼‚æ­¥æ‰§è¡Œï¼ˆAsynchronizeï¼‰, ç¨åä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æä¸ä»‹ç»ã€‚æˆ‘ä»¬è¦çŸ¥é“é˜Ÿåˆ—ç¬¬GCDçš„åŸºç¡€ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160512103228905-1463046040.png)

#### 1.è·å–å½“å‰çº¿ç¨‹ä¸å½“å‰çº¿ç¨‹ä¼‘çœ 

é¦–å…ˆæˆ‘ä»¬å°†è·å–å½“å‰çº¿ç¨‹çš„æ–¹æ³•è¿›è¡Œå°è£…ï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬ä¼šç»å¸¸æŸ¥çœ‹æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯åœ¨é‚£äº›çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚åœ¨æ­¤æˆ‘ä»¬ä½¿ç”¨äº†NSThreadçš„currentThread()æ–¹æ³•æ¥è·å–å½“å‰çº¿ç¨‹ã€‚ä¸‹æ–¹çš„getCurrentThread()æ–¹æ³•å°±æ˜¯æˆ‘ä»¬æå–çš„è·å–å½“å‰çº¿ç¨‹çš„æ–¹æ³•ã€‚æ–¹æ³•å†…å®¹æ¯”è¾ƒç®€å•ï¼Œåœ¨æ­¤å°±ä¸åšè¿‡å¤šèµ˜è¿°äº†ã€‚
```Swift
/**
 è·å–å½“å‰çº¿ç¨‹
 
 - returns: NSThread
 */
func getCurrentThread() -> Thread {
    let currentThread = Thread.current
    return currentThread
}
```
ã€€ã€€

ä¸Šè¿°ä»£ç æ®µæ˜¯è·å–å½“å‰çº¿ç¨‹çš„æ–¹æ³•ï¼Œæ¥ç€æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªè®©å½“å‰çº¿ç¨‹ä¼‘çœ çš„æ–¹æ³•ã€‚å› ä¸ºæˆ‘ä»¬åœ¨ç¤ºä¾‹æ—¶ï¼Œå¸¸å¸¸ä¼šè®©å½“å‰çº¿ç¨‹æ¥ä¼‘çœ ä¸€æ®µæ—¶é—´æ¥æ¨¡æ‹Ÿé‚£äº›è€—æ—¶çš„æ“ä½œã€‚ä¸‹æ–¹ä»£ç æ®µä¸­çš„currentThreadSleep()å‡½æ•°å°±æ˜¯æˆ‘ä»¬æå–çš„å½“å‰çº¿ç¨‹ä¼‘çœ çš„å‡½æ•°ã€‚è¯¥å‡½æ•°æœ‰ä¸€ä¸ªNSTimeIntervalç±»å‹çš„å‚æ•°ï¼Œè¯¥å‚æ•°å°±æ˜¯è¦ä¼‘çœ çš„æ—¶é—´ã€‚NSTimeIntervalå…¶å®å°±æ˜¯Doubleç±»å‹çš„åˆ«åï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨currentThreadSleep()æ–¹æ³•æ—¶éœ€è¦ä¼ å…¥ä¸€ä¸ªDoubleç±»å‹çš„ä¼‘çœ æ—¶é—´ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥è°ƒç”¨sleep()æ–¹æ³•æ¥å¯¹å½“å‰çº¿ç¨‹è¿›è¡Œä¼‘çœ ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯sleep()çš„å‚æ•°æ˜¯UInt32ä½çš„æ•´å‹ã€‚ä¸‹æ–¹å°±æ˜¯æˆ‘ä»¬ä¼‘çœ å½“å‰çº¿ç¨‹çš„å‡½æ•°ã€‚
```Swift
/**
 å½“å‰çº¿ç¨‹ä¼‘çœ 
 
 - parameter timer: ä¼‘çœ æ—¶é—´/å•ä½ï¼šs
 */
func currentThreadSleep(_ timer: TimeInterval) -> Void {
    Thread.sleep(forTimeInterval: timer)
    
    //æˆ–è€…ä½¿ç”¨
    //sleep(UInt32(timer))
}
```

#### 2.è·å–ä¸»é˜Ÿåˆ—ä¸å…¨å±€é˜Ÿåˆ—

ä¸‹æ–¹å°è£…çš„getMainQueue()å‡½æ•°å°±æ˜¯è·å–ä¸»é˜Ÿåˆ—çš„å‡½æ•°ï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬åœ¨å…¶ä»–çº¿ç¨‹ä¸­å¤„ç†å®Œè€—æ—¶çš„ä»»åŠ¡ï¼ˆæ¯”å¦‚ç½‘ç»œè¯·æ±‚ï¼‰åï¼Œéœ€è¦åœ¨ä¸»é˜Ÿåˆ—ä¸­å¯¹UIè¿›è¡Œæ›´æ–°ã€‚å› ä¸ºæˆ‘ä»¬çŸ¥é“åœ¨iOSä¸­æœ‰ä¸ªRunLoopçš„æ¦‚å¿µï¼Œåœ¨iOSç³»ç»Ÿä¸­è§¦æ‘¸äº‹ä»¶ã€å±å¹•åˆ·æ–°ç­‰éƒ½æ˜¯åœ¨RunLoopä¸­åšçš„ã€‚å› ä¸ºæœ¬ç¯‡åšå®¢çš„ä¸»é¢˜æ˜¯GCD, åœ¨æ­¤å°±å¯¹RunLoopåšè¿‡å¤šçš„èµ˜è¿°äº†ï¼Œå¦‚æœä½ å¯¹RunLoopä¸å¤ªäº†è§£ï¼Œé‚£ä¹ˆä½ å°±å…ˆç®€å•å°†RunLoopç†è§£æˆ1/60æ‰§è¡Œä¸€æ¬¡çš„å¾ªç¯å³å¯ï¼Œå½“ç„¶çœŸæ­£çš„RunLoopè¦æ¯”ä¸€ä¸ªå•çº¯çš„å¾ªç¯å¤æ‚çš„å¤šï¼Œä»¥åæœ‰æœºä¼šçš„è¯åœ¨ä»¥RunLoopä¸ºä¸»é¢˜æ›´æ–°ä¸€ç¯‡åšå®¢å§ã€‚è¨€å½’æ­£ä¼ ï¼Œä¸‹æ–¹å°±æ˜¯è·å–æˆ‘ä»¬ä¸»é˜Ÿåˆ—çš„æ–¹æ³•ï¼Œç®€å•ä¸€ç‚¹çš„è¯´å› ä¸ºæˆ‘ä»¬è¦æ›´æ–°UIï¼Œæ‰€ä»¥è¦è·å–ä¸»é˜Ÿåˆ—ã€‚
```Swift
/**
 è·å–ä¸»é˜Ÿåˆ—
 
 - returns: dispatch_queue_t
 */
func getMainQueue() -> DispatchQueue {
    return DispatchQueue.main
}
```
ã€€ã€€

æ¥ä¸‹æ¥æˆ‘ä»¬è¦å°è£…ä¸€ä¸ªè·å–å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰çš„å‡½æ•°ï¼Œåœ¨å°è£…å‡½æ•°ä¹‹å‰æˆ‘ä»¬å…ˆæ¥èŠèŠä»€ä¹ˆæ˜¯å…¨å±€é˜Ÿåˆ—ã€‚å…¨å±€é˜Ÿåˆ—æ˜¯ç³»ç»Ÿæä¾›çš„ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—æ‹¿è¿‡æ¥å°±èƒ½ç”¨ï¼ŒæŒ‰æ‰§è¡Œæ–¹å¼æ¥è¯´ï¼Œå…¨å±€é˜Ÿåˆ—åº”è¯¥ç§°å¾—ä¸Šæ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œå…³äºä¸²å¹¶è¡Œé˜Ÿåˆ—çš„å…·ä½“æ¦‚å¿µä¸‹æ–¹ä¼šç»™å‡ºä»‹ç»ã€‚æˆ‘ä»¬åœ¨è·å–å…¨å±€é˜Ÿåˆ—çš„æ—¶å€™è¦çŸ¥é“å…¶é˜Ÿåˆ—çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§è¶Šé«˜çš„é˜Ÿåˆ—å°±è¶Šå…ˆæ‰§è¡Œï¼Œå½“ç„¶è¯¥å¤„çš„ä¼˜å…ˆçº§ä¸æ˜¯ç»å¯¹çš„ã€‚é˜Ÿåˆ—çœŸæ­£çš„æ‰§è¡Œé¡ºåºè¿˜éœ€è¦æ ¹æ®CUPå½“å‰çš„çŠ¶æ€æ¥å®šï¼Œå¤§éƒ¨åˆ†æ˜¯æŒ‰ç…§ä½ æŒ‡å®šçš„é˜Ÿåˆ—ä¼˜å…ˆçº§æ¥æ‰§è¡Œçš„ï¼Œä¸è¿‡ä¹Ÿæœ‰ä¾‹å¤–ã€‚ä¸‹æ–¹å®ä¾‹ä¼šç»™å‡ºè¯¦ç»†çš„ä»‹ç»ã€‚ä¸‹æ–¹å°±æ˜¯æˆ‘ä»¬è·å–å…¨å±€é˜Ÿåˆ—çš„å‡½æ•°ï¼Œåœ¨è·å–å…¨å±€é˜Ÿåˆ—ä¸ºä¸ºå…¨å±€é˜Ÿåˆ—æŒ‡å®šä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¸ºDISPATCH_QUEUE_PRIORITY_DEFAULTã€‚
```Swift
/**
 è·å–å…¨å±€é˜Ÿåˆ—
*/

func getGlobalQueue() -> DispatchQueue {
    return DispatchQueue.global()
    
}

```
ã€€ã€€

#### 3.åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—ä¸å¹¶è¡Œé˜Ÿåˆ—

å› ä¸ºæˆ‘ä»¬åœ¨å®ç°å®ä¾‹æ—¶ä¼šåˆ›å»ºä¸€äº›å¹¶è¡Œé˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯¹å¹¶è¡Œé˜Ÿåˆ—çš„åˆ›å»ºäºä¸²è¡Œé˜Ÿåˆ—çš„åˆ›å»ºè¿›è¡Œæå–ã€‚GCDä¸­æ˜¯è°ƒç”¨dispatch_queue_create()å‡½æ•°æ¥åˆ›å»ºæˆ‘ä»¬æƒ³è¦çš„çº¿ç¨‹çš„ã€‚dispatch_queue_create()å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é˜Ÿåˆ—çš„æ ‡ç¤ºï¼Œç”¨æ¥æ ‡ç¤ºä½ åˆ›å»ºçš„é˜Ÿåˆ—å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯åŸŸåçš„å€’å†™å¦‚â€œcn.zeluliâ€è¿™ç§å½¢å¼ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰€åˆ›å»ºé˜Ÿåˆ—çš„ç±»å‹ï¼ŒDISPATCH_QUEUE_CONCURRENTå°±è¯´æ˜åˆ›å»ºçš„æ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼ŒDISPATCH_QUEUE_SERIALè¡¨æ˜ä½ åˆ›å»ºçš„æ˜¯ä¸²è¡Œé˜Ÿåˆ—ã€‚è‡³äºä¸¤è€…çš„åŒºåˆ«ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œä¸‹æ–¹å®ä¾‹ä¸­ä¼šç»™å‡ºè¯¦ç»†çš„ä»‹ç»ã€‚
```Swift
/**
 åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—
 
 - parameter label: å¹¶è¡Œé˜Ÿåˆ—çš„æ ‡è®°
 
 - returns: å¹¶è¡Œé˜Ÿåˆ—
 */
func getConcurrentQueue(_ label: String) -> DispatchQueue {
    return DispatchQueue(label: label, attributes: DispatchQueue.Attributes.concurrent)
}


/**
 åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—
 
 - parameter label: ä¸²è¡Œé˜Ÿåˆ—çš„æ ‡ç­¾
 
 - returns: ä¸²è¡Œé˜Ÿåˆ—
 */
func getSerialQueue(_ label: String) -> DispatchQueue {
    return DispatchQueue(label: label)
}
```

### äºŒã€åŒæ­¥æ‰§è¡Œä¸å¼‚æ­¥æ‰§è¡Œ

åŒæ­¥æ‰§è¡Œå¯åˆ†ä¸ºä¸²è¡Œé˜Ÿåˆ—çš„åŒæ­¥æ‰§è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—çš„åŒæ­¥æ‰§è¡Œï¼Œè€Œå¼‚æ­¥æ‰§è¡Œåˆå¯åˆ†ä¸ºä¸²è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œã€‚ä¹Ÿè®¸å¬èµ·æ¥æœ‰äº›æ‹—å£ï¼Œä¸é€šè¿‡ä¸‹æ–¹çš„å›¾è§£ä½ ä¼šå¾ˆå¥½çš„ç†è§£è¿™ä¸€æ¦‚å¿µã€‚ä¸Šä¸€éƒ¨åˆ†ç®—æ˜¯æˆ‘ä»¬çš„å‡†å¤‡å·¥ä½œï¼Œæ¥ä¸‹æ¥æ‰æ˜¯æˆ‘ä»¬çœŸæ­£çš„ä¸»é¢˜ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬å®ç°äº†è·å–å½“å‰çº¿ç¨‹ï¼Œå¯¹å½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œè·å–ä¸»é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—ä»¥åŠåˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ã€‚åœ¨æœ¬éƒ¨åˆ†å°†è¦åˆ©ç”¨ä¸Šè¿°å‡½æ•°æ¥è¿›ä¸€æ­¥è®¨è®ºä¸²è¡Œé˜Ÿåˆ—ä¸å¹¶è¡Œé˜Ÿåˆ—çš„åŒæ­¥æ‰§è¡Œï¼Œä»¥åŠä¸²è¡Œé˜Ÿåˆ—ä¸å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œã€‚å¹¶ä¸”ä¼šç»™å‡ºåŒæ­¥æ‰§è¡Œä¸å¼‚æ­¥æ‰§è¡Œçš„åŒºåˆ«ã€‚

åœ¨èŠåŒæ­¥æ‰§è¡Œä¸å¼‚æ­¥æ‰§è¡Œä¹‹å‰æˆ‘ä»¬å…ˆèŠèŠä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Queueï¼‰ä¸å¹¶è¡Œé˜Ÿåˆ—ï¼ˆConcurrent Queueï¼‰çš„åŒºåˆ«ã€‚æ— è®ºæ˜¯Serial Queueè¿˜æ˜¯Concurrent Queueï¼Œéƒ½æ˜¯é˜Ÿåˆ—ï¼Œåªè¦æ˜¯é˜Ÿåˆ—éƒ½éµå¾ªFIFOï¼ˆFirst In First Out -- å…ˆå…¥å…ˆå‡ºï¼‰çš„è§„åˆ™ï¼Œæ’é˜Ÿå˜›ï¼Œå½“ç„¶æ˜¯è°å…ˆæ¥çš„è°å…ˆèµ°äº†ã€‚ä¸è¿‡åœ¨Serial Queueä¸­è¦ç­‰åˆ°å‰é¢çš„ä»»åŠ¡å‡ºé˜Ÿåˆ—å¹¶æ‰§è¡Œå®Œåï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡æ‰èƒ½å‡ºé˜Ÿåˆ—è¿›è¡Œæ‰§è¡Œã€‚è€ŒConcurrent Queueåˆ™ä¸ç„¶ï¼Œåªè¦æ˜¯é˜Ÿåˆ—å‰é¢çš„ä»»åŠ¡å‡ºé˜Ÿåˆ—äº†ï¼Œå¹¶ä¸”è¿˜æœ‰æœ‰ç©ºä½™çº¿ç¨‹ï¼Œä¸ç®¡å‰é¢çš„ä»»åŠ¡æ˜¯å¦æ‰§è¡Œå®Œäº†ï¼Œä¸‹ä¸€ä»»åŠ¡éƒ½å¯ä»¥è¿›è¡Œå‡ºé˜Ÿåˆ—ã€‚

å…³äºä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶è¡Œé˜Ÿåˆ—çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿é“¶è¡ŒåŠä¸šåŠ¡æ’é˜Ÿæ¥ç±»æ¯”ä¸€ä¸‹ã€‚æ¯”å¦‚ä½ ç°åœ¨åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­æ’çš„æ˜¯1å·çª—å£ï¼Œä½ å¿…é¡»ç­‰å‰é¢ä¸€ä¸ªäººåœ¨1å·çª—å£åŠå®Œä¸šåŠ¡ä½ æ‰å¯ä»¥å»1å·çª—å£ä¸­å»åŠä½ çš„ä¸šåŠ¡ï¼Œå°±ç®—å…¶ä»–çª—å£ç©ºç€ä½ ä¹Ÿä¸èƒ½å»ï¼Œå› ä¸ºä½ é€‰æ‹©çš„æ˜¯ä¸²è¡Œé˜Ÿåˆ—ã€‚ä½†æ˜¯å¦‚æœä½ æ˜¯åœ¨å¹¶è¡Œé˜Ÿåˆ—ä¸­çš„è¯ï¼Œåªè¦ä½ å‰é¢çš„äººå»çª—å£ä¸­åŠä¸šåŠ¡äº†ï¼Œæ­¤æ—¶ä½ æ— éœ€å…³ç³»ä½ å‰é¢çš„äººçš„ä¸šåŠ¡æ˜¯å¦åŠå®Œäº†ï¼Œåªè¦æœ‰å…¶ä»–çª—å£ç©ºç€ä½ å°±å¯ä»¥å»åŠç†ä½ çš„ä¸šåŠ¡ã€‚æ€»ç»“ä¸€ä¸‹ï¼šä¸²è¡Œé˜Ÿåˆ—å°±æ˜¯è®¤å‡†ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€æ¡é“èµ°åˆ°é»‘ï¼Œæ¯”è¾ƒä¸“æ³¨ï¼›å¹¶è¡Œé˜Ÿåˆ—å°±æ˜¯èƒ½åˆ©ç”¨å…¶ä»–çº¿ç¨‹å°±åˆ©ç”¨ï¼Œæ¯”è¾ƒçµæ´»ï¼Œä¸é’»ç‰›è§’å°–ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦çœ‹ä¸€ä¸‹ä¸¤ä¸ªé˜Ÿåˆ—çš„ä¸åŒæ‰§è¡Œæ–¹æ³•ã€‚

#### 1.åŒæ­¥æ‰§è¡Œ

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥ä»‹ç»åŒæ­¥æ‰§è¡Œï¼Œå…³äºåŒæ­¥æ‰§è¡Œçš„ä¸»è¦å®ä¾‹å¯¹åº”ç€â€œåŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—â€å’Œâ€œåŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—â€è¿™ä¸¤ä¸ªæŒ‰é’®ã€‚Serial Queueå¯ä»¥åŒæ­¥æ‰§è¡Œï¼ŒConcurrent Queueäº¦å¯ä»¥åŒæ­¥æ‰§è¡Œã€‚æˆ‘ä»¬å…ˆæŠ›å¼€é˜Ÿåˆ—ï¼Œçœ‹ä¸€ä¸‹åŒæ­¥æ‰§è¡Œçš„ä»£ç å¦‚ä½•ã€‚ä¸‹æ–¹çš„å‡½æ•°å°±æ˜¯å¯¹åŒæ­¥æ‰§è¡Œçš„ä»»åŠ¡è¿›è¡Œå°è£…ã€‚åŒæ­¥æ‰§è¡Œå°±æ˜¯ä½¿ç”¨dispatch_sync()æ–¹æ³•è¿›è¡Œæ‰§è¡Œã€‚åœ¨ä¸‹æ–¹å‡½æ•°ä¸­é€šè¿‡for-inå¾ªç¯ä»¥åŒæ­¥æ‰§è¡Œçš„æ–¹å¼å¾€queueï¼ˆé˜Ÿåˆ—ï¼‰ä¸­æ·»åŠ äº†3ä¸ªBlockæ‰§è¡Œå—ã€‚å‡½æ•°çš„å‚æ•°æ˜¯é˜Ÿåˆ—ç±»å‹ï¼ˆdispatch_queue_tï¼‰,å¯ä»¥ç»™è¯¥å‡½æ•°ä¼ å…¥ä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶è¡Œé˜Ÿåˆ—ã€‚
```Swift
/**
é˜Ÿåˆ—çš„åŒæ­¥æ‰§è¡Œ
 
 - parameter queue: é˜Ÿåˆ—
 */
func performQueuesUseSynchronization(_ queue: DispatchQueue) -> Void {
    
    for i in 0..<3 {
        queue.sync {
            currentThreadSleep(1)
            print("å½“å‰æ‰§è¡Œçº¿ç¨‹ï¼š\(getCurrentThread())")
            print("æ‰§è¡Œ\(i)")
        }
        print("\(i)æ‰§è¡Œå®Œæ¯•")
    }
    print("æ‰€æœ‰é˜Ÿåˆ—ä½¿ç”¨åŒæ­¥æ–¹å¼æ‰§è¡Œå®Œæ¯•")
}
```

ä¹Ÿå°±æ˜¯è¯´è¦åŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—å°±ç»™å‡½æ•°ä¼ å…¥ä¸²è¡Œé˜Ÿåˆ—çš„å¯¹è±¡ï¼Œå¦‚æœè¦åŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—å°±ä¼ å…¥å¹¶è¡Œé˜Ÿåˆ—å¯¹è±¡ã€‚æ­¤æ—¶æˆ‘ä»¬å°±ç”¨åˆ°äº†ä¹‹å‰å°è£…çš„åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶è¡Œé˜Ÿåˆ—çš„æ–¹æ³•ï¼ˆå‚è§ç¬¬ä¸€éƒ¨åˆ†ï¼‰ã€‚ä¸‹æ–¹ä»£ç æ®µå°±æ˜¯ç‚¹å‡»â€œåŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—â€å’Œâ€œåŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—â€è¿™ä¸¤ä¸ªæŒ‰é’®æ‰€åšçš„äº‹æƒ…ã€‚ç‚¹å‡»â€œåŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—â€æŒ‰é’®æ—¶å°±åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—çš„å¯¹è±¡ä¼ ç»™ä¸Šé¢åŒæ­¥æ‰§è¡Œçš„å‡½æ•°ï¼ˆperformQueuesUseSynchronization()ï¼‰ï¼Œç‚¹å‡»â€œåŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—â€æŒ‰é’®æ—¶å°±åˆ›å»ºä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—çš„å¯¹è±¡ç»™ä¸Šé¢çš„å‡½æ•°ã€‚
```Swift
    //åŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—
    @IBAction func tapButton1(_ sender: AnyObject) {
        print("\nåŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—")
        performQueuesUseSynchronization(getSerialQueue("syn.serial.queue"))
    }
    
    //åŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—
    @IBAction func tapButton2(_ sender: AnyObject) {
        print("\nåŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—")
        performQueuesUseSynchronization(getConcurrentQueue("syn.concurrent.queue"))
    }

```
ã€€

ä¸‹æ–¹æˆªå›¾æ˜¯ç‚¹å‡»ä¸¤ä¸ªæŒ‰é’®æ‰€è¿è¡Œçš„ç»“æœã€‚çº¢æ¡†ä¸­æ˜¯åŒæ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—çš„ç»“æœï¼Œå¯ä»¥çœ‹å‡ºæ¥æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸‹æŒ‰ç€FIFOçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚è€Œç»¿æ¡†ä¸­çš„æ˜¯åŒæ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—çš„è¿è¡Œç»“æœï¼Œä»ç»“æœä¸­éƒ¨é—¨ä¸éš¾çœ‹å‡ºï¼Œä¸çº¢æ¡†ä¸­çš„ç»“æœä¸€è‡´ï¼Œä¹Ÿæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æŒ‰ç€FIFOçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160512125713093-1246190699.png)
ã€€ã€€

é€šè¿‡ä¸Šé¢ä¸¤ç§ä¸åŒé˜Ÿåˆ—çš„åŒæ­¥æ‰§è¡Œæ–¹å¼æˆ‘ä»¬ç»™å‡ºäº†ä¸‹é¢çš„åˆ†æå›¾ã€‚Serial Queueä¸Concurrent Queueä¸­éƒ½æœ‰4ä¸ªBlockï¼ˆç¼–å·ä¸º1--4ï¼‰ï¼Œç„¶åä½¿ç”¨dispatch_sync()æ¥åŒæ­¥æ‰§è¡Œã€‚ç”±ä¸Šè¿°ç¤ºä¾‹æˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼ŒåŒæ­¥æ‰§è¡Œæ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨dispatch_sync()æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸ä¼šå¼€è¾Ÿæ–°çš„çº¿ç¨‹ï¼Œä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œå› ä¸ºä¸»çº¿ç¨‹è¢«é˜»å¡äº†ï¼Œå°±ä¼šä¼šé€ æˆUIå¡æ­»çš„ç°è±¡ã€‚å› ä¸ºåŒæ­¥æ‰§è¡Œæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æ¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨å¯ä»¥ä¾›é˜Ÿåˆ—ä½¿ç”¨çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ä¸²è¡Œé˜Ÿåˆ—ä¸å¹¶è¡Œé˜Ÿåˆ—ä½¿ç”¨åŒæ­¥æ‰§è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¿…é¡»ç­‰åˆ°ä¸Šä¸€ä¸ªä»»åŠ¡å‡ºé˜Ÿåˆ—å¹¶æ‰§è¡Œå®Œæ¯•åæ‰å¯ä»¥å»æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŒæ­¥æ‰§è¡Œçš„è¿™ä¸ªç‰¹ç‚¹æ¥ä¸ºä¸€äº›ä»£ç å—åŠ åŒæ­¥é”ã€‚ä¸‹æ–¹å°±æ˜¯ä¸Šé¢ä»£ç ä»¥åŠæ‰§è¡Œç»“æœçš„æè¿°å›¾ã€‚

![](http://images2015.cnblogs.com/blog/545446/201603/545446-20160330103502082-703612739.png)
   

 

#### 2ã€å¼‚æ­¥æ‰§è¡Œ

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹å¼‚æ­¥æ‰§è¡Œï¼ŒåŒæ ·å¼‚æ­¥æ‰§è¡Œä¹Ÿåˆ†ä¸ºä¸²è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œã€‚åœ¨GCDä¸­ä½¿ç”¨dispatch_async()å‡½æ•°æ¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œdispatch_async()å‡½æ•°çš„å‚æ•°ä¸dispatch_sync()å‡½æ•°çš„å‚æ•°ä¸€è‡´ã€‚åªä¸è¿‡æ˜¯dispatch_async()å¼‚æ­¥æ‰§è¡Œä¸ä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå®ƒä¼šå¼€è¾Ÿæ–°çš„çº¿ç¨‹ï¼Œæ‰€ä»¥å¼‚æ­¥æ‰§è¡Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚ä¸‹æ–¹ä»£ç æ®µå°±æ˜¯æˆ‘ä»¬å°è£…çš„å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°ï¼Œå…¶ä¸­ä¸»è¦æ˜¯å¯¹dispatch_async()å‡½æ•°çš„ä½¿ç”¨ã€‚ä¸‹æ–¹ä¸ºäº†è®©é˜Ÿåˆ—ä¸­çš„Blockçš„ä¸‰ä¸ªè¾“å‡ºè¯­å¥é¡ºåºè¾“å‡ºï¼Œæˆ‘ä»¬å°†å…¶æ”¾åœ¨äº†ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ä¸­æ¥æ‰§è¡Œï¼Œä»è€Œè¿™ä¸‰ä¸ªè¾“å‡ºè¯­å¥å¯ä»¥é¡ºåºæ‰§è¡Œã€‚
```Swift
/**
 é˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œ
 
 - parameter queue: é˜Ÿåˆ—
 */
func performQueuesUseAsynchronization(_ queue: DispatchQueue) -> Void {
    
    //ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œç”¨äºåŒæ­¥æ‰§è¡Œ
    let serialQueue = getSerialQueue("serialQueue")
    
    for i in 0..<3 {
        queue.async {
            currentThreadSleep(Double(arc4random()%3))
            let currentThread = getCurrentThread()
            
            serialQueue.sync(execute: {              //åŒæ­¥é”
                print("Sleepçš„çº¿ç¨‹\(currentThread)")
                print("å½“å‰è¾“å‡ºå†…å®¹çš„çº¿ç¨‹\(getCurrentThread())")
                print("æ‰§è¡Œ\(i):\(queue)\n")
            })
        }
        
        print("\(i)æ·»åŠ å®Œæ¯•\n")
    }
    print("ä½¿ç”¨å¼‚æ­¥æ–¹å¼æ·»åŠ é˜Ÿåˆ—")
}

```
ã€€ã€€ 

##### (1)ã€ä¸²è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œ

æœ‰äº†ä¸Šé¢çš„å‡½æ•°åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™ä¸Šé¢çš„å‡½æ•°ä¼ å…¥Serial Queueé˜Ÿåˆ—çš„å¯¹è±¡ï¼Œä»è€Œè§‚å¯Ÿä¸²è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œç»“æœã€‚å¯¹åº”è¿™æˆ‘ä»¬ç¬¬ä¸€å¼ æˆªå›¾ä¸­çš„â€œå¼‚æ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—â€çš„æŒ‰é’®ï¼Œä¸‹æ–¹æ˜¯ç‚¹å‡»è¯¥æŒ‰é’®æ‰§è¡Œçš„æ–¹æ³•ã€‚åœ¨è¯¥æŒ‰é’®ç‚¹å‡»çš„æ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†performQueuesUseAsynchronization()æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥äº†ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚ä¹Ÿå°±æ˜¯ä¸²è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œã€‚
```Swift
    @IBAction func tapButton3(_ sender: AnyObject) {
        print("\nå¼‚æ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—")
        performQueuesUseAsynchronization(getSerialQueue("asyn.serial.queue"))
    }
```
ã€€ã€€

ç‚¹å‡»æŒ‰é’®å°±ä¼šæ‰§è¡Œä¸Šè¿°æ–¹æ³•ï¼Œä¸‹æ–¹æ˜¯ç‚¹å‡»æŒ‰é’®åï¼Œä¹Ÿå°±æ˜¯â€œå¼‚æ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—â€æ—¶åœ¨æ§åˆ¶å°ä¸­è¾“å‡ºçš„ç»“æœã€‚ä»è¾“å‡ºç»“æœä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œå¼‚æ­¥æ‰§è¡Œå¹¶æ²¡æœ‰é˜»å¡å½“å‰çº¿ç¨‹ã€‚ä½¿ç”¨dispatch_saync()å¼€è¾Ÿäº†æ–°çš„çº¿ç¨‹ï¼ˆçº¿ç¨‹çš„number = 3ï¼‰æ¥æ‰§è¡ŒBlockä¸­çš„å†…å®¹ã€‚è€ŒBlockå†…å®¹å¤–çš„ä¸œè¥¿ä¾ç„¶åœ¨ä¹‹å‰çš„çº¿ç¨‹ï¼ˆåœ¨è¯¥ç¤ºä¾‹ä¸­æ˜¯main_threadï¼‰ä¸­è¿›è¡Œæ‰§è¡Œã€‚ä»ä¸‹æ–¹çš„ç»“æœä¸­æ¥åˆ†æï¼Œå°±æ˜¯forå¾ªç¯æ‰§è¡Œå®Œæ¯•åä¸»çº¿ç¨‹çš„ä»»åŠ¡å°±ç»“æŸäº†ï¼Œè‡³äºBlockä¸­çš„å†…å®¹å°±äº¤ç»™æ–°å¼€è¾Ÿçš„çº¿ç¨‹3æ¥æ‰§è¡Œäº†ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160512143000562-264723884.png)
ã€€ã€€

 

æ ¹æ®ä¸Šé¢çš„è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ç”»å‡ºä¸‹æ–¹å¼‚æ­¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—çš„åˆ†æå›¾ã€‚åœ¨çº¿ç¨‹1ä¸­çš„ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—å¦‚æœä½¿ç”¨å¼‚æ­¥æ‰§è¡Œçš„è¯ï¼Œä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„çº¿ç¨‹2æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„Blockä»»åŠ¡ã€‚åœ¨æ–°å¼€è¾Ÿçš„çº¿ç¨‹ä¸­ä¾ç„¶æ˜¯FIFO, å¹¶ä¸”æ‰§è¡Œé¡ºåºæ˜¯ç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚å¦‚ä¸‹æ‰€ç¤ºã€‚

![](http://images2015.cnblogs.com/blog/545446/201603/545446-20160330103516660-460259528.png)
 ã€€ã€€

#### (2)ã€å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œ

æ¥ä¸‹æ¥æ¥è®¨è®ºä¸€ä¸‹å¹¶è¡Œé˜Ÿåˆ—çš„å¼‚æ­¥æ‰§è¡Œæ–¹å¼ã€‚å…¶å®å¹¶è¡Œé˜Ÿåˆ—ä¸å¼‚æ­¥æ‰§è¡Œæ–¹å¼ç›¸ç»“åˆæ‰èƒ½å¤§å¤§çš„æä¾›æ•ˆç‡ï¼Œå› ä¸ºä½¿ç”¨å¼‚æ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—æ—¶ä¼šå¼€è¾Ÿå¤šä¸ªçº¿ç¨‹æ¥åŒæ—¶æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚æ¯”å¦‚ç°åœ¨å¼€è¾Ÿäº†10ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå¼‚æ­¥é˜Ÿåˆ—ä¼šæ ¹æ®FIFOçš„é¡ºåºå‡ºæ¥10ä¸ªä»»åŠ¡ï¼Œè¿™10ä¸ªä»»åŠ¡ä¼šè¿›å…¥åˆ°ä¸åŒçš„çº¿ç¨‹ä¸­æ¥æ‰§è¡Œï¼Œè‡³äºæ¯ä¸ªä»»åŠ¡æ‰§è¡Œå®Œçš„å…ˆåé¡ºåºç”±æ¯ä¸ªä»»åŠ¡çš„å¤æ‚åº¦è€Œå®šã€‚å¼‚æ­¥é˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯åªè¦æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼Œä»»åŠ¡å°±ä¼šå‡ºé˜Ÿåˆ—è¿›è¡Œæ‰§è¡Œï¼Œè€Œä¸å…³å¿ƒä¹‹å‰å‡ºé˜Ÿåˆ—çš„ä»»åŠ¡ï¼ˆBlockï¼‰æ˜¯å¦æ‰§è¡Œå®Œæ¯•ã€‚ä¸‹æ–¹çš„æ–¹æ³•å°±æ˜¯ç‚¹å‡»â€œå¼‚æ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—â€æŒ‰é’®æ‰€è°ƒç”¨çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šè°ƒç”¨performQueuesUseAsynchronization()å‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—çš„å¯¹è±¡ã€‚
```Swift
    @IBAction func tapButton4(_ sender: AnyObject) {
        print("\nå¼‚æ­¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—")
        performQueuesUseAsynchronization(getConcurrentQueue("asyn.concurrent.queue"))
        
    }
```
ã€€ã€€

ç‚¹å‡»æŒ‰é’®å°±ä¼šæ‰§è¡Œä¸Šè¿°æ–¹æ³•ï¼Œå¹¶è¡Œé˜Ÿåˆ—å°±ä¼šå¼‚æ­¥æ‰§è¡Œã€‚ä¸‹æ–¹ç»“æœå°±æ˜¯å¹¶è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œåè¾“å‡ºçš„ç»“æœï¼Œè§£ææ¥è®©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¾“å‡ºç»“æœã€‚ä¸‹æ–¹ç¬¬ä¸€ä¸ªçº¢æ¡†ä¸­æ˜¯å¹¶è¡Œé˜Ÿåˆ—ä¸­ä»»åŠ¡çš„é¡ºåºï¼Œç”±å‰åˆ°åä¸º0ã€1ã€2ï¼Œç´§æ¥ç€æ˜¯æ¯ä¸ªä»»åŠ¡æ‰§è¡Œåæ‰€è¾“å‡ºçš„ç»“æœã€‚ä»ä»»åŠ¡æ‰§è¡Œå®Œæ‰“å°ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œå®Œæˆçš„é¡ºåºæ˜¯2ã€1ã€0ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸­æ¥æ‰§è¡Œçš„ã€‚å¦‚æœä½ åœ¨ç‚¹å‡»ä¸€ä¸‹æŒ‰é’®ï¼Œæ‰§è¡Œå®Œæˆçš„é¡ºåºæœ‰å¯èƒ½æ˜¯2ã€0ã€1ç­‰å…¶ä»–çš„é¡ºåºï¼Œæ‰€ä»¥å¹¶è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œä¸­æ¯ä¸ªä»»åŠ¡ç»“æŸæ—¶é—´æœ‰ä¸»è¦ç”±ä»»åŠ¡æœ¬èº«çš„å¤æ‚åº¦è€Œå®šçš„ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160512145425140-1349786405.png)

æ ¹æ®ä¸Šé¢çš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬ç”»å‡ºäº†ä¸‹æ–¹çš„è§£è¯´å›¾ã€‚å½“å¹¶è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œæ—¶ä¼šå¼€è¾Ÿå¤šä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å‡ºé˜Ÿåˆ—çš„é¡ºåºä»ç„¶æ˜¯FIFOï¼Œåªä¸è¿‡æ˜¯ä¸éœ€è¦ç­‰åˆ°å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œè€Œå·²ï¼Œåªè¦æ˜¯æœ‰ç©ºä½™çº¿ç¨‹å¯ä»¥ä½¿ç”¨å°±å¯ä»¥æŒ‰FIFOçš„é¡ºåºå‡ºé˜Ÿåˆ—è¿›è¡Œæ‰§è¡Œã€‚ 

![](http://images2015.cnblogs.com/blog/545446/201603/545446-20160330103525363-1740347484.png)



### ä¸‰ã€å»¶è¿Ÿæ‰§è¡Œ

åœ¨GCDä¸­æˆ‘ä»¬ä½¿ç”¨dispatch_after()å‡½æ•°æ¥å»¶è¿Ÿæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡, dispatch_after()æ˜¯å¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨dispatch_after()æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸ä¼šé˜»å¡å½“å‰ä»»åŠ¡ã€‚ç­‰åˆ°å»¶è¿Ÿæ—¶é—´åˆ°äº†ä»¥åå°±ä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„çº¿ç¨‹ç„¶åæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚è¦æ³¨æ„ä¸€ç‚¹æ˜¯å»¶è¿Ÿæ—¶é—´åˆ°äº†åå†å¼€è¾Ÿæ–°çš„çº¿ç¨‹ç„¶åç«‹å³æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ä¸‹æ–¹æ˜¯dispatch_after()å‡½æ•°çš„ä½¿ç”¨æ–¹å¼ã€‚

åœ¨ä¸‹æ–¹ä»£ç ä¸­ä½¿ç”¨äº†ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºå»¶è¿Ÿæ—¶é—´ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨dispatch_time()æ¥åˆ›å»ºå»¶è¿Ÿæ—¶é—´ï¼Œå¦ä¸€ä¸ªæ˜¯ä½¿ç”¨dispatch_walltime()æ¥åˆ›å»ºæ—¶é—´ã€‚å‰è€…æ˜¯å–çš„æ˜¯å½“å‰è®¾å¤‡çš„æ—¶é—´ï¼Œåè€…å»çš„æ˜¯æŒ‚é’Ÿçš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ç»å¯¹æ—¶é—´ï¼Œå¦‚æœè®¾å¤‡ä¼‘çœ äº†é‚£ä¹ˆå‰è€…ä¹Ÿå°±ä¼‘çœ äº†ï¼Œè€Œåè€…æ˜¯æ˜¯æ ¹æ®æŒ‚é’Ÿæ—¶é—´ä¸ä¼šæœ‰å½“å‰è®¾å¤‡çš„çŠ¶æ€è€Œå·¦å³çš„ã€‚ä¸‹é¢åœ¨åˆ›å»ºdispatch_time_tå¯¹è±¡çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªå‚æ•°æ˜¯NSEC_PER_SECï¼Œä»å‘½ååªèƒ½æ€ªæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“NSEC_PER_SECè¡¨ç¤ºä»€ä¹ˆæ„æ€ï¼Œå°±æ˜¯æ¯ç§’åŒ…å«å¤šå°‘çº³ç§’ã€‚ä½ å¯ä»¥å°†è¯¥å€¼è¿›è¡Œæ‰“å°ï¼Œå‘ç°NSEC_PER_SEC = 1_000_000_000ã€‚ä¹Ÿå°±æ˜¯ä¸€ç§’ç­‰äº10äº¿çº³ç§’ã€‚å¦‚æœä¸‹æ–¹çš„timeä¸ä¹˜äºNSEC_PER_SECé‚£ä¹ˆå°±ä»£è¡¨1çº³ç§’çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤å¤„çš„æ—¶é—´æ˜¯æŒ‰çº³ç§’ï¼ˆnanosecondï¼‰æ¥è®¡ç®—çš„ã€‚ä¸‹æ–¹å°±æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„çš„ä»£ç ï¼Œå› ä¸ºæ”¹ä»£ç è¾“å‡ºç»“æœæ¯”è¾ƒç®€å•ï¼Œåœ¨æ­¤å°±ä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å»¶è¿Ÿæ‰§è¡Œä¼šåœ¨æ–°å¼€è¾Ÿçš„é˜Ÿåˆ—ä¸­è¿›è¡Œæ‰§è¡Œï¼Œä¸ä¼šé˜»å¡æ–°çš„çº¿ç¨‹ã€‚
```Swift
/**
 å»¶è¿Ÿæ‰§è¡Œ
 
 - parameter time: å»¶è¿Ÿæ‰§è¡Œçš„æ—¶é—´
 */
func deferPerform(_ time: Double) -> Void {
    
    //dispatch_timeç”¨äºè®¡ç®—ç›¸å¯¹æ—¶é—´,å½“è®¾å¤‡ç¡çœ æ—¶ï¼Œdispatch_timeä¹Ÿå°±è·Ÿç€ç¡çœ äº†
    let delayTime: DispatchTime = DispatchTime.now() + Double(Int64(time * Double(NSEC_PER_SEC))) / Double(NSEC_PER_SEC)
    getGlobalQueue().asyncAfter(deadline: delayTime) {
        print("æ‰§è¡Œçº¿ç¨‹ï¼š\(getCurrentThread())\ndispatch_time: å»¶è¿Ÿ\(time)ç§’æ‰§è¡Œ\n")
    }
    
    //dispatch_walltimeç”¨äºè®¡ç®—ç»å¯¹æ—¶é—´,è€Œdispatch_walltimeæ˜¯æ ¹æ®æŒ‚é’Ÿæ¥è®¡ç®—çš„æ—¶é—´ï¼Œå³ä½¿è®¾å¤‡ç¡çœ äº†ï¼Œä»–ä¹Ÿä¸ä¼šç¡çœ ã€‚
    let nowInterval = Date().timeIntervalSince1970
    let nowStruct = timespec(tv_sec: Int(nowInterval), tv_nsec: 0)
    let delayWalltime = DispatchWallTime(timespec: nowStruct)
    getGlobalQueue().asyncAfter(wallDeadline: delayWalltime) {
        print("æ‰§è¡Œçº¿ç¨‹ï¼š\(getCurrentThread())\ndispatch_walltime: å»¶è¿Ÿ\(time)ç§’æ‰§è¡Œ\n")
    }
    
    print(NSEC_PER_SEC) //ä¸€ç§’æœ‰å¤šå°‘çº³ç§’
}

```

### å››ã€é˜Ÿåˆ—çš„ä¼˜å…ˆçº§

é˜Ÿåˆ—ä¹Ÿæ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼Œä½†å…¶ä¼˜å…ˆçº§ä¸æ˜¯ç»å¯¹çš„å¤§éƒ¨åˆ†æƒ…å†µå› ä¸ºXUNå†…æ ¸ç”¨äºGCDä¸æ˜¯å®æ—¶æ€§çš„ï¼Œä¼˜å…ˆçº§åªæ˜¯å¤§è‡´çš„æ¥åˆ¤æ–­é˜Ÿåˆ—çš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚é˜Ÿåˆ—åˆ†ä¸ºå››ä¸ªä¼˜å…ˆçº§ï¼Œç”±é«˜åˆ°åº•åˆ†åˆ«æ˜¯High > Default > Low > Backgroundã€‚ä¸Šé¢åœ¨è·å–å…¨å±€é˜Ÿåˆ—æ—¶æˆ‘ä»¬å¯ä»¥ä¸ºè·å–çš„é˜Ÿåˆ—æŒ‡å®šä¼˜å…ˆçº§ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨dispatch_set_target_queue()å‡½æ•°å°†ä¸€ä¸ªé˜Ÿåˆ—çš„ä¼˜å…ˆçº§èµ‹å€¼ç»™å¦ä¸€ä¸ªé˜Ÿåˆ—ã€‚ä¸‹æ–¹æˆ‘ä»¬å…ˆç»™å…¨å±€é˜Ÿåˆ—æŒ‡å®šä¼˜å…ˆçº§ï¼Œç„¶ååœ¨å°†å…¶èµ‹å€¼ç»™å…¶ä»–é˜Ÿåˆ—ã€‚

#### 1.ä¸ºå…¨å±€é˜Ÿåˆ—æŒ‡å®šä¼˜å…ˆçº§

æœ¬éƒ¨åˆ†å¯¹åº”ç€â€œè®¾ç½®å…¨å±€é˜Ÿåˆ—çš„ä¼˜å…ˆçº§â€è¿™ä¸ªbuttonï¼Œç‚¹å‡»è¯¥buttonå°±ä¼šè·å–4ä¸ªä¸åŒä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—ï¼Œç„¶åå¼‚æ­¥è¿›è¡Œå…¨å±€é˜Ÿåˆ—çš„æ‰§è¡Œï¼Œæœ€åè§‚å¯Ÿæ‰§è¡Œçš„ç»“æœã€‚ä¸‹æ–¹å°±æ˜¯ç‚¹å‡»è¯¥æŒ‰é’®æ‰€è¦æ‰§è¡Œçš„å‡½æ•°ã€‚æˆ‘å…ˆè·å–äº†å››ç§ä¸åŒä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—ï¼Œç„¶åè¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œå¹¶æ‰“å°æ‰§è¡Œç»“æœã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160512165620937-1464678076.png)

ä¸Šè¿°ä»£ç çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼Œè™½ç„¶åœ¨ä¸Šè¿°ä»£ç ä¸­ä¼˜å…ˆçº§é«˜çš„ä»£ç æ”¾åœ¨äº†æœ€åæ¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œå¯æ˜¯å´å…ˆè¢«æ‰“å°äº†ã€‚æ‰“å°çš„é¡ºåºæ˜¯Hight->Default->Low->Backgroundï¼Œè¿™ä¸ªæ‰“å°é¡ºåºå°±æ˜¯å…¶æ‰§è¡Œé¡ºåºï¼Œä»æ‰“å°é¡ºåºä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºä¼˜å…ˆçº§é«˜çš„å…ˆè¢«æ‰§è¡Œã€‚å½“ç„¶è¿™ä¸æ˜¯ç»å¯¹çš„ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160512165807843-1528734355.png)
ã€€ã€€ 

#### 2.ä¸ºè‡ªåˆ›å»ºçš„é˜Ÿåˆ—æŒ‡å®šä¼˜å…ˆçº§

åœ¨GCDä¸­ä½ å¯ä»¥ä½¿ç”¨dispatch_set_target_queue()å‡½æ•°ä¸ºä½ è‡ªå·±åˆ›å»ºçš„é˜Ÿåˆ—æŒ‡å®šä¼˜å…ˆçº§ï¼Œè¿™ä¸ªè¿‡ç¨‹è¿˜éœ€å€ŸåŠ©æˆ‘ä»¬çš„å…¨å±€é˜Ÿåˆ—ã€‚ä¸‹æ–¹çš„ä»£ç æ®µä¸­æˆ‘ä»¬å…ˆåˆ›å»ºäº†ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡dispatch_set_target_queue()å‡½æ•°å°†å…¨å±€é˜Ÿåˆ—ä¸­çš„é«˜ä¼˜å…ˆçº§èµ‹å€¼ç»™æˆ‘ä»¬åˆšåˆ›å»ºçš„è¿™ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚
```Swift
/**
 ç»™ä¸²è¡Œé˜Ÿåˆ—æˆ–è€…å¹¶è¡Œé˜Ÿåˆ—è®¾ç½®ä¼˜å…ˆçº§
 */
func setCustomeQueuePriority() {
    //ä¼˜å…ˆçº§çš„æ‰§è¡Œé¡ºåºä¹Ÿä¸æ˜¯ç»å¯¹çš„
    // DispatchQoS.userInteractive
    //Work is virtually instantaneous.
    
    //DispatchQoS.userInitiated
    //Work is nearly instantaneous, such as a few seconds or less.
    
    //DispatchQoS.utility
    //Work takes a few seconds to a few minutes.
    
    //DispatchQoS.background
    //Work takes significant time, such as minutes or hours.
    
    print("userInteractive & userInitiated")
    let queue1 = DispatchQueue(label:"zeluli.queue1", qos: DispatchQoS.userInteractive)
    let queue2 = DispatchQueue(label:"zeluli.queue2", qos: DispatchQoS.userInitiated)
    queue1.async {
        for i in 100..<110{
            print("ğŸ˜„", i, getCurrentThread())
        }
    }
    
    queue2.async {
        for i in 200..<210{
            print("ğŸ˜­", i, getCurrentThread())
        }
    }
    
    
    sleep(1)
    
    print("\n\n=========ç¬¬äºŒæ‰¹==========\n")
    print("userInitiated & utility")
    let queue3 = DispatchQueue(label:"zeluli.queue3", qos: DispatchQoS.userInitiated)
    let queue4 = DispatchQueue(label:"zeluli.queue4", qos: DispatchQoS.utility)
    
    queue3.async {
        for i in 300..<310{
            print("ğŸ˜„", i, getCurrentThread())
        }
    }
    
    queue4.async {
        for i in 400..<410{
            print("ğŸ˜­", i, getCurrentThread())
        }
    }
    
    
    sleep(1)
    print("\n\n=========ç¬¬ä¸‰æ‰¹==========\n")
    print("utility & background")
    let queue5 = DispatchQueue(label:"zeluli.queue5", qos: DispatchQoS.utility)
    let queue6 = DispatchQueue(label:"zeluli.queue6", qos: DispatchQoS.background)
    
    queue5.async {
        for i in 500..<510{
            print("ğŸ˜„", i, getCurrentThread())
        }
    }
    
    queue6.async {
        for i in 600..<610{
            print("ğŸ˜­", i, getCurrentThread())
        }
    }
}

```
ã€€ã€€

 

### äº”ã€ä»»åŠ¡ç»„dispatch_group

GCDçš„ä»»åŠ¡ç»„åœ¨å¼€å‘ä¸­æ˜¯ç»å¸¸è¢«ä½¿ç”¨åˆ°ï¼Œå½“ä½ ä¸€ç»„ä»»åŠ¡ç»“æŸåå†æ‰§è¡Œä¸€äº›æ“ä½œæ—¶ï¼Œä½¿ç”¨ä»»åŠ¡ç»„åœ¨åˆé€‚ä¸è¿‡äº†ã€‚dispatch_groupçš„èŒè´£å°±æ˜¯å½“é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ååœ¨å»åšä¸€äº›æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä»»åŠ¡ç»„ä¸­æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åå°±ä¼šå‘å‡ºä¸€ä¸ªé€šçŸ¥æ¥å‘Šè¯‰ç”¨æˆ·ä»»åŠ¡ç»„ä¸­æ‰€æ‰§è¡Œçš„é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•äº†ã€‚å…³äºå°†é˜Ÿåˆ—æ”¾åˆ°ä»»åŠ¡ç»„ä¸­æ‰§è¡Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨dispatch_group_async()å‡½æ•°ï¼Œå°†é˜Ÿåˆ—ä¸ä»»åŠ¡ç»„è¿›è¡Œå…³è”å¹¶è‡ªåŠ¨æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯æ‰‹åŠ¨çš„å°†é˜Ÿåˆ—ä¸ç»„è¿›è¡Œå…³è”ç„¶åä½¿ç”¨å¼‚æ­¥å°†é˜Ÿåˆ—è¿›è¡Œæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯dispatch_group_enter()ä¸dispatch_group_leave()æ–¹æ³•çš„ä½¿ç”¨ã€‚ä¸‹æ–¹å°±ç»™å‡ºè¯¦ç»†çš„ä»‹ç»ã€‚

#### 1.é˜Ÿåˆ—ä¸ç»„è‡ªåŠ¨å…³è”å¹¶æ‰§è¡Œ

é¦–å…ˆæˆ‘ä»¬æ¥ä»‹ç»dispatch_group_async()å‡½æ•°çš„ä½¿ç”¨æ–¹å¼ï¼Œè¯¥å‡½æ•°ä¼šå°†é˜Ÿåˆ—ä¸ç›¸åº”çš„ä»»åŠ¡ç»„è¿›è¡Œå…³è”ï¼Œå¹¶ä¸”è‡ªåŠ¨æ‰§è¡Œã€‚å½“ä¸ä»»åŠ¡ç»„å…³è”çš„é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œä¼šé€šè¿‡dispatch_group_notify()å‡½æ•°å‘å‡ºé€šçŸ¥å‘Šè¯‰ç”¨æˆ·ä»»åŠ¡ç»„ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•äº†ã€‚ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼æ˜¯ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹çš„ï¼Œå¦‚æœä½ ä½¿ç”¨dispatch_group_wait()å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡ç»„ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ã€‚

ä¸‹æ–¹å°è£…çš„å‡½æ•°å°±æ˜¯ä½¿ç”¨dispatch_group_async()å‡½æ•°å°†é˜Ÿåˆ—ä¸ä»»åŠ¡ç»„è¿›è¡Œå…³è”å¹¶æ‰§è¡Œã€‚é¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªconcurrentQueueå¹¶è¡Œé˜Ÿåˆ—ï¼Œç„¶ååˆåˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸ºdispatch_group_tçš„ä»»åŠ¡ç»„groupã€‚ä½¿ç”¨dispatch_group_async()å‡½æ•°å°†ä¸¤è€…è¿›è¡Œå…³è”å¹¶æ‰§è¡Œã€‚ä½¿ç”¨dispatch_group_notify()å‡½æ•°è¿›è¡Œç›‘å¬groupä¸­é˜Ÿåˆ—çš„æ‰§è¡Œç»“æœï¼Œå¦‚æœæ‰§è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬å°±åœ¨ä¸»çº¿ç¨‹ä¸­å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚dispatch_group_notify()å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯å‘é€é€šçŸ¥çš„groupï¼Œå¦ä¸€ä¸ªæ˜¯å¤„ç†è¿”å›ç»“æœçš„é˜Ÿåˆ—ã€‚
```Swift
/**
 ä¸€ç»„é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•ååœ¨æ‰§è¡Œéœ€è¦æ‰§è¡Œçš„ä¸œè¥¿ï¼Œå¯ä»¥ä½¿ç”¨dispatch_groupæ¥æ‰§è¡Œé˜Ÿåˆ—
 */
func performGroupQueue() {
    print("\nä»»åŠ¡ç»„è‡ªåŠ¨ç®¡ç†ï¼š")
    
    let concurrentQueue: DispatchQueue = getConcurrentQueue("cn.zeluli")
    let group: DispatchGroup = DispatchGroup()
    
    //å°†groupä¸queueè¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸”è‡ªåŠ¨æ‰§è¡Œ
    for i in 1...3 {
        concurrentQueue.async(group: group) {
            currentThreadSleep(1)
            print("ä»»åŠ¡\(i)æ‰§è¡Œå®Œæ¯•\n")
        }
    }
    
    //é˜Ÿåˆ—ç»„çš„éƒ½æ‰§è¡Œå®Œæ¯•åä¼šè¿›è¡Œé€šçŸ¥
    group.notify(queue: getMainQueue()) {
        print("æ‰€æœ‰çš„ä»»åŠ¡ç»„æ‰§è¡Œå®Œæ¯•ï¼\n")
    }

    print("å¼‚æ­¥æ‰§è¡Œæµ‹è¯•ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹")
}
```
ã€€ã€€
è°ƒç”¨ä¸Šè¿°å‡½æ•°çš„è¾“å‡ºç»“æœå¦‚ä¸‹ã€‚ä»è¾“å‡ºç»“æœä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œé˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ‰§è¡Œä»¥åŠé€šçŸ¥ç»“æœçš„å¤„ç†éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸ä¼šé˜»å¡å½“å‰çš„çº¿ç¨‹ã€‚åœ¨ä»»åŠ¡ç»„ä¸­æ‰€æœ‰ä»»åŠ¡éƒ½å¤„ç†å®Œæ¯•åï¼Œå°±ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œdispatch_group_notify()ä¸­çš„é—­åŒ…å—ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160513101051827-1882544247.png)
ã€€ã€€

#### 2.æ‰‹åŠ¨å…³è”é˜Ÿåˆ—ä¸ä»»åŠ¡ç»„

æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ‰‹åŠ¨çš„ç®¡ç†ä»»åŠ¡ç»„ä¸é˜Ÿåˆ—ä¸­çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯ä¸ä½¿ç”¨dispatch_group_async()å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨dispatch_group_enter()ä¸dispatch_group_leave()å‡½æ•°å°†é˜Ÿåˆ—ä¸­çš„æ¯æ¬¡ä»»åŠ¡åŠ å…¥åˆ°åˆ°ä»»åŠ¡ç»„ä¸­ã€‚é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨dispatch_group_enter()å‡½æ•°è¿›å…¥åˆ°ä»»åŠ¡ç»„ä¸­ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œæœ€åä½¿ç”¨dispatch_group_leave()å‡½æ•°ç¦»å¼€ä»»åŠ¡ç»„å³å¯ã€‚ä¸‹é¢çš„å‡½æ•°ä¸­æˆ‘ä»¬ä½¿ç”¨äº†dispatch_group_wait()å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„èŒè´£å°±æ˜¯é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ¥ç­‰å¾…ä»»åŠ¡ç»„ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰€è¦ç­‰å¾…çš„groupï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œæ­¤å¤„æˆ‘ä»¬è®¾ç½®çš„æ˜¯DISPATCH_TIME_FOREVERï¼Œå°±è¯´æ˜ç­‰å¾…ä»»åŠ¡ç»„çš„æ‰§è¡Œæ°¸ä¸è¶…æ—¶ï¼Œç›´åˆ°ä»»åŠ¡ç»„ä¸­æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚
```Swift

/**
 * ä½¿ç”¨enterä¸leaveæ‰‹åŠ¨ç®¡ç†groupä¸queue
 */
func performGroupUseEnterAndleave() {
    print("\nä»»åŠ¡ç»„æ‰‹åŠ¨ç®¡ç†ï¼š")
    let concurrentQueue: DispatchQueue = getConcurrentQueue("cn.zeluli")
    let group: DispatchGroup = DispatchGroup()
    
    //å°†groupä¸queueè¿›è¡Œæ‰‹åŠ¨å…³è”å’Œç®¡ç†ï¼Œå¹¶ä¸”è‡ªåŠ¨æ‰§è¡Œ
    for i in 1...3 {
        group.enter()                     //è¿›å…¥é˜Ÿåˆ—ç»„
        
        concurrentQueue.async(execute: {
            currentThreadSleep(1)
            print("ä»»åŠ¡\(i)æ‰§è¡Œå®Œæ¯•\n")
            
            group.leave()                 //ç¦»å¼€é˜Ÿåˆ—ç»„
        })
    }
    group.wait()//é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
    print("ä»»åŠ¡ç»„æ‰§è¡Œå®Œæ¯•")
    
    group.notify(queue: concurrentQueue) {
        print("æ‰‹åŠ¨ç®¡ç†çš„é˜Ÿåˆ—æ‰§è¡ŒOK")
    }
}
```
ã€€ã€€

ä¸‹æ–¹æ˜¯ä¸Šè¿°å‡½æ•°æ‰§è¡Œåçš„è¾“å‡ºç»“æœï¼Œdispatch_group_wait()å‡½æ•°ä¸‹æ–¹çš„print()å‡½æ•°åœ¨æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹å‰æ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ï¼Œå› ä¸ºdispatch_group_wait()ä¼šå°†å½“å‰çº¿ç¨‹è¿›è¡Œé˜»å¡ã€‚å½“ç„¶è™½ç„¶æ˜¯æ‰‹åŠ¨çš„å°†é˜Ÿåˆ—ä¸ä»»åŠ¡ç»„è¿›è¡Œå…³è”çš„ï¼Œdisplay_group_notify()å‡½æ•°è¿˜æ˜¯å¥½ç”¨çš„ã€‚è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160513102949046-1178719390.png)
ã€€ã€€

 

### å…­ã€ä¿¡å·é‡(semaphore)åŒæ­¥é”

æœ‰æ—¶å€™å¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªæ•°æ®è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œä¸ºäº†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬åªå…è®¸ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œè¿™ä¸ªæ•°æ®ã€‚ä¸ºäº†ä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥ä¿®æ”¹æˆ‘ä»¬çš„èµ„æºæ•°æ®ï¼Œæˆ‘ä»¬å°±å¾—ç”¨åˆ°ä¿¡å·é‡åŒæ­¥é”äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå­˜æ”¾èµ„æºæˆ¿é—´çš„é—¨åè¾¹åˆæŠŠé”ï¼Œå½“æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›åˆ°è¿™ä¸ªæˆ¿é—´åå°±å°†è¿™æŠŠé”é”ä¸Šã€‚å½“è¿™ä¸ªçº¿ç¨‹ä¿®æ”¹å®Œè¯¥èµ„æºåï¼Œå°±å°†é”ç»™æ‰“å¼€ï¼Œé”æ‰“å¼€åå…¶ä»–çš„çº¿ç¨‹å°±å¯ä»¥æŒæœ‰èµ„æºäº†ã€‚å¦‚æœä½ ä¸Šäº†é”ä¸æ‰“å¡ï¼Œè€Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ä½¿ç”¨è¯¥èµ„æºæ—¶ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚æ‰€ä»¥å½“ä½ ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±ä¸è¦æŒæœ‰èµ„æºå‘¢ã€‚

ä¸Šè¿°è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨GCDä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¿¡å·é‡æœºåˆ¶æ¥å®Œæˆã€‚åœ¨GCDä¸­æœ‰ä¸€ä¸ªå«dispatch_semaphore_tçš„ä¸œè¥¿ï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„ä¿¡å·é‡ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ä¿¡å·é‡è¿›è¡Œæ“ä½œï¼Œå¦‚æœä¿¡å·é‡ä¸º0é‚£ä¹ˆå°±æ˜¯ä¸Šé”çš„çŠ¶æ€ï¼Œå…¶ä»–çº¿ç¨‹æƒ³ä½¿ç”¨èµ„æºå°±å¾—ç­‰å¾…äº†ã€‚å¦‚æœä¿¡å·é‡ä¸ä¸ºé›¶ï¼Œé‚£ä¹ˆå°±æ˜¯å¼€é”çŠ¶æ€ï¼Œå¼€é”çŠ¶æ€ä¸‹èµ„æºå°±å¯ä»¥è®¿é—®ã€‚ä¸‹æ–¹ä»£ç å°±æ˜¯ä¿¡å·é‡çš„å…·ä½“ä½¿ç”¨ä»£ç ã€‚

ä¸‹æ–¹ç¬¬ä¸€ä¸ªçº¢æ¡†ä¸­å°±æ˜¯é€šè¿‡dispatch_semaphore_create()æ¥åˆ›å»ºä¿¡å·é‡ï¼Œè¯¥å‡½æ•°éœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°æ‰€æŒ‡å®šçš„å°±æ˜¯ä¿¡å·é‡çš„å€¼ï¼Œæˆ‘ä»¬ä¸ºä¿¡å·æŒ‡å®šçš„å€¼ä¸º1ã€‚ç¬¬äºŒä¸ªçº¢æ¡†ä¸­æ˜¯â€œä¸Šé”çš„è¿‡ç¨‹â€ï¼Œé€šè¿‡dispatch_semaphore_wait()å‡½æ•°å¯¹ä¿¡å·é‡æ“ä½œï¼Œè¯¥å‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰€æ“ä½œçš„ä¿¡å·é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç­‰å¾…æ—¶é—´ã€‚dispatch_semaphore_wait()å‡½æ•°æ˜¯å¯¹ä¿¡å·é‡å‡ä¸€ï¼Œä¿¡å·é‡ä¸ºé›¶çš„è¯å°±å¯¹å½“å‰çº¿ç¨‹æ‰€æ“ä½œçš„èµ„æºåŠ é”ã€‚å…¶ä»–çº¿ç¨‹ç­‰å¾…å½“å‰çº¿ç¨‹æ“ä½œèµ„æºçš„æ—¶é—´ä¸ºDISPATCH_TIME_FOREVERï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä»–çº¿ç¨‹è¦ä¸€ç›´ç­‰ä¸‹å»ï¼Œç­‰å¾…å½“å‰çº¿ç¨‹æ“ä½œèµ„æºå®Œæ¯•ã€‚å½“å½“å‰çº¿ç¨‹å¯¹èµ„æºæ“ä½œå®Œæ¯•åè°ƒç”¨dispatch_semaphore_signal()å°†ä¿¡å·é‡åŠ 1ï¼Œå°†èµ„æºè¿›è¡Œè§£é”ï¼Œä»¥ä¾¿äºå…¶ä»–ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œèµ„æºçš„è®¿é—®ã€‚å½“è§£é”åï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…çš„æ—¶é—´ç»“æŸï¼Œå°±å¯ä»¥è¿›è¡Œèµ„æºçš„è®¿é—®äº†ã€‚
```Swift

//ä¿¡å·é‡åŒæ­¥é”
func useSemaphoreLock() {
    
    let concurrentQueue = getConcurrentQueue("cn.zeluli")
    
    //åˆ›å»ºä¿¡å·é‡
    let semaphoreLock: DispatchSemaphore = DispatchSemaphore(value: 1)
    
    var testNumber = 0
    
    for index in 1...10 {
        concurrentQueue.async(execute: {
            semaphoreLock.wait()//ä¸Šé”
            
            testNumber += 1
            currentThreadSleep(Double(1))
            print(getCurrentThread())
            print("ç¬¬\(index)æ¬¡æ‰§è¡Œ: testNumber = \(testNumber)\n")
            
            semaphoreLock.signal()                      //å¼€é”
            
        })
    }
    print("å¼‚æ­¥æ‰§è¡Œæµ‹è¯•\n")
}
```
ã€€ã€€

 

### ä¸ƒã€é˜Ÿåˆ—çš„å¾ªç¯ã€æŒ‚èµ·ã€æ¢å¤

åœ¨æœ¬ç¯‡åšå®¢çš„ç¬¬ä¸ƒéƒ¨åˆ†ï¼Œæˆ‘ä»¬è¦èŠä¸€ä¸‹é˜Ÿåˆ—çš„å¾ªç¯æ‰§è¡Œä»¥åŠé˜Ÿåˆ—çš„æŒ‚èµ·ä¸æ¢å¤ã€‚è¯¥éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ã€‚åœ¨é‡å¤æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨dispatch_apply()å‡½æ•°ï¼Œè¯¥å‡½æ•°å¾ªç¯æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä½†æ˜¯dispatch_apply()å‡½æ•°æœ¬èº«ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚å¦‚æœä½ ä½¿ç”¨dispatch_apply()å‡½æ•°æ¥æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—ï¼Œè™½ç„¶ä¼šå¼€å¯å¤šä¸ªçº¿ç¨‹æ¥å¾ªç¯æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä»ç„¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚å¦‚æœä½ ä½¿ç”¨dispatch_apply()å‡½æ•°æ¥æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå¼€è¾Ÿæ–°çš„çº¿ç¨‹ï¼Œå½“ç„¶å°±ä¼šå°†å½“å‰çº¿ç¨‹è¿›è¡Œé˜»å¡ã€‚è¯´åˆ°é˜Ÿåˆ—çš„æŒ‚èµ·ä¸æ¢å¤ä½ å¯ä»¥ä½¿ç”¨dispatch_suspend()æ¥æŒ‚èµ·é˜Ÿåˆ—ï¼Œä½¿ç”¨dispatch_resum()æ¥æ¢å¤é˜Ÿåˆ—ã€‚è¯·çœ‹ä¸‹æ–¹å®ä¾‹ã€‚

#### 1ã€dispatch_apply()å‡½æ•°

dispatch_apply()å‡½æ•°æ˜¯ç”¨æ¥å¾ªç¯æ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡çš„ï¼Œä½¿ç”¨æ–¹å¼ä¸ºï¼šdispatch_apply(å¾ªç¯æ¬¡æ•°, ä»»åŠ¡æ‰€åœ¨çš„é˜Ÿåˆ—) { è¦å¾ªç¯æ‰§è¡Œçš„ä»»åŠ¡ }ã€‚ä½¿ç”¨è¯¥å‡½æ•°å¾ªç¯æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ—¶ï¼Œä¼šå¼€è¾Ÿæ–°çš„çº¿ç¨‹ï¼Œä¸è¿‡æœ‰å¯èƒ½ä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä¸€äº›ä»»åŠ¡ã€‚è€Œä½¿ç”¨dispatch_apply()æ‰§è¡Œä¸²è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ—¶ï¼Œä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œã€‚æ— è®ºæ˜¯ä½¿ç”¨å¹¶è¡Œé˜Ÿåˆ—è¿˜æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œdispatch_apply()éƒ½ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚ä¸‹æ–¹ä»£ç æ®µå°±æ˜¯dispatch_apply()çš„ä½¿ç”¨ç¤ºä¾‹ï¼š
```Swift
/**
 å¾ªç¯æ‰§è¡Œ_ç±»ä¼¼äºdispatch_apply
 */
func useDispatchApply() {
    
    print("å¾ªç¯å¤šæ¬¡æ‰§è¡Œå¹¶è¡Œé˜Ÿåˆ—")
    DispatchQueue.concurrentPerform(iterations: 10) { (index) in
        currentThreadSleep(Double(index))
        print("ç¬¬\(index)æ¬¡æ‰§è¡Œï¼Œ\n\(getCurrentThread())\n")
    }
}
```
ã€€ã€€

ä¸‹æ–¹åˆ™æ˜¯ä¸Šè¿°å‡½æ•°çš„è¿è¡Œç»“æœã€‚åœ¨ç»“æœä¸­æˆ‘ä»¬å°†æ¯æ¬¡æ‰§è¡Œä»»åŠ¡æ‰€ä½¿ç”¨çš„çº¿ç¨‹è¿›è¡Œäº†æ‰“å°ã€‚

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160513133453202-605153159.png)
ã€€ã€€

 

#### 2.é˜Ÿåˆ—çš„æŒ‚èµ·ä¸å”¤é†’

é˜Ÿåˆ—çš„æŒ‚èµ·ä¸å”¤é†’ç›¸å¯¹è¾ƒä¸ºç®€å•ï¼Œå¦‚æœä½ æƒ³å¯¹ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡çš„æ‰§è¡Œè¿›è¡ŒæŒ‚èµ·ï¼Œé‚£ä¹ˆä½ å°±ä½¿ç”¨dispatch_suspend()å‡½æ•°å³å¯ã€‚å¦‚æœä½ è¦å”¤é†’æŸä¸ªæŒ‚èµ·çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥ä½¿ç”¨dispatch_resum()å‡½æ•°ã€‚è¿™ä¸¤ä¸ªå‡½æ•°æ‰€éœ€çš„å‚æ•°éƒ½æ˜¯ä½ è¦æŒ‚èµ·æˆ–è€…å”¤é†’çš„é˜Ÿåˆ—ï¼Œé‰´äºçŸ¥è¯†ç‚¹çš„ç®€å•æ€§å°±ä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ã€‚ä¸‹æ–¹æ˜¯å¯¹å¼‚æ­¥æ‰§è¡Œçš„å¹¶è¡Œé˜Ÿåˆ—è¿›è¡ŒæŒ‚èµ·ï¼Œåœ¨å½“å‰çº¿ç¨‹ä¼‘çœ 2ç§’åå”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š
```Swift
//æš‚åœå’Œé‡å¯é˜Ÿåˆ—
func queueSuspendAndResume() {
    let concurrentQueue = getConcurrentQueue("cn.zeluli")
    
    concurrentQueue.suspend()   //å°†é˜Ÿåˆ—è¿›è¡ŒæŒ‚èµ·
    concurrentQueue.async { 
        print("ä»»åŠ¡æ‰§è¡Œ")
    }
    
    currentThreadSleep(2)
    concurrentQueue.resume()    //å°†æŒ‚èµ·çš„é˜Ÿåˆ—è¿›è¡Œå”¤é†’
}

```
ã€€ã€€

 

### å…«ã€ä»»åŠ¡æ …æ dispatch_barrier_async()

é¡¾åæ€ä¹‰ï¼Œä»»åŠ¡æ …æ å°±æ˜¯å°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿›è¡Œéš”ç¦»çš„ï¼Œæ˜¯ä»»åŠ¡èƒ½åˆ†æ‹¨çš„è¿›è¡Œå¼‚æ­¥æ‰§è¡Œã€‚æˆ‘æƒ³ç”¨ä¸‹æ–¹çš„å›¾æ¥ä»‹ç»ä¸€ä¸‹barrierçš„ä½œç”¨ã€‚æˆ‘ä»¬å‡è®¾ä¸‹æ–¹æ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œç„¶åå¹¶è¡Œé˜Ÿåˆ—ä¸­æœ‰1.1ã€1.2ã€2.1ã€2.2å››ä¸ªä»»åŠ¡ï¼Œå‰ä¸¤ä¸ªä»»åŠ¡ä¸åä¸¤ä¸ªä»»åŠ¡æœ¬ä¸­é—´çš„æ …æ ç»™éš”å¼€äº†ã€‚å¦‚æœæ²¡æœ‰ä¸­é—´çš„æ …æ çš„è¯ï¼Œå››ä¸ªä»»åŠ¡ä¼šåœ¨å¼‚æ­¥çš„æƒ…å†µä¸‹åŒæ—¶æ‰§è¡Œã€‚ä½†æ˜¯æœ‰æ …æ çš„æ‹¦ç€çš„è¯ï¼Œä¼šå…ˆæ‰§è¡Œæ …æ å‰é¢çš„ä»»åŠ¡ã€‚ç­‰å‰é¢çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•äº†ï¼Œä¼šæ‰§è¡Œæ …æ è‡ªå¸¦çš„Block ï¼Œæœ€åå¼‚æ­¥æ‰§è¡Œæ …æ åæ–¹çš„ä»»åŠ¡ã€‚è¿™ä¹ˆä¸€è¯´æœ‰ç‚¹ä¸å‰é¢çš„dispatch_groupç±»ä¼¼ï¼Œå½“æ‰§è¡Œå®Œä¸€äº›åˆ—çš„ä»»åŠ¡åï¼Œæˆ‘ä»¬æƒ³åšä¸€äº›äº‹æƒ…çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯é€šè¿‡dispatch_barrier_async()æ¥å®ç°ã€‚
![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160513135414905-908843240.png)
ã€€ã€€

ä¸‹æ–¹ä»£ç æ®µå°±æ˜¯æˆ‘ä»¬dispatch_barrier_async(), å…·ä½“çš„ä½¿ç”¨æ–¹å¼ã€‚ä¸Šé¢çš„çº¢è‰²æ¡†ä¸­çš„ä»£ç æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ç¬¬ä¸€æ‰¹ä»»åŠ¡ï¼Œä¸­é—´æ˜¯æˆ‘ä»¬ç»™ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ çš„ä»»åŠ¡æ …æ ï¼Œdispatch_barrier_asyn()çš„ä¸€ä¸ªå‚æ•°å°±æ˜¯æ …æ æ‰€åœ¨çš„é˜Ÿåˆ—ï¼Œè€Œåè¾¹çš„å°¾éšé—­åŒ…å°±æ˜¯åœ¨æ …æ å‰é¢çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åå°±ä¼šæ‰§è¡Œè¯¥å°¾éšé—­åŒ…ä¸­çš„å†…å®¹ã€‚è€Œæœ€ä¸‹æ–¹é»„è‰²æ¡†ä¸­çš„éƒ¨åˆ†å°±æ˜¯ç¬¬äºŒæ‰¹æ¬¡æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¯¥æ‰¹ä»»åŠ¡ä¼šåœ¨dispatch_barrier_asyn()æ …æ çš„å°¾éšé—­åŒ…æ‰§è¡Œåä¼šç»§ç»­æ‰§è¡Œã€‚
```Swift
/**
 ä½¿ç”¨ç»™é˜Ÿåˆ—åŠ æ …æ 
 */
func useBarrierAsync() {
    let concurrentQueue: DispatchQueue = getConcurrentQueue("cn.zeluli")
    for i in 0...3 {
        concurrentQueue.async {
            currentThreadSleep(Double(i))
            print("ç¬¬ä¸€æ‰¹ï¼š\(i)\(getCurrentThread())")
        }
    }
    
    
    concurrentQueue.async(flags: .barrier, execute: {
        print("\nç¬¬ä¸€æ‰¹æ‰§è¡Œå®Œæ¯•åæ‰ä¼šæ‰§è¡Œç¬¬äºŒæ‰¹\n\(getCurrentThread())\n")
    }) 
    
    
    for i in 0...3 {
        concurrentQueue.async {
            currentThreadSleep(Double(i))
            print("ç¬¬äºŒæ‰¹ï¼š\(i)\(getCurrentThread())")
        }
    }
    
    print("å¼‚æ­¥æ‰§è¡Œæµ‹è¯•\n")
}

```
ã€€ã€€

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸Šè¿°ä»£ç çš„è¿è¡Œç»“æœï¼Œç‚¹å‡»æˆ‘ä»¬ç¬¬ä¸€éƒ¨åˆ†æˆªå›¾çš„â€œä½¿ç”¨ä»»åŠ¡éš”ç¦»æ …æ â€æŒ‰é’®å°±ä¼šæ‰§è¡Œä¸Šè¿°æ–¹æ³•ã€‚ä¸‹æ–¹å°±æ˜¯ä¸Šè¿°ä»£ç ç‰‡æ®µçš„è¿è¡Œç»“æœã€‚ä»ä¸‹é¢çš„è¾“å‡ºç»“æœä¸­ä¸éš¾çœ‹å‡ºï¼Œdispatch_barrier_asynä¹‹å‰çš„ä»»åŠ¡ä¼šå…ˆå¼‚æ­¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä¸‹æ–¹çš„ç¬¬ä¸€æ‰¹ä»»åŠ¡ã€‚ç¬¬ä¸€æ‰¹ä»»åŠ¡å®Œæˆåï¼Œä¼šåœ¨ç¬¬ä¸€æ‰¹ä»»åŠ¡ä¸­çš„æœ€åå®Œæˆä»»åŠ¡çš„çº¿ç¨‹ä¸­æ¥æ‰§è¡Œæ …æ ä¸­çš„ä»»åŠ¡å—ã€‚å½“æ …æ ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œé˜Ÿåˆ—ä¸­çš„ç¬¬äºŒæ‰¹ä»»åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ªä¼šè¿›å…¥æ‰§è¡Œæ …æ ä»»åŠ¡çš„çº¿ç¨‹ä¸­æ¥æ‰§è¡Œï¼Œå…¶ä»–çš„ä¼šå¼€è¾Ÿæ–°çš„çº¿ç¨‹ã€‚å¦‚ä¸‹æ‰€ç¤ºã€‚
![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160514155735359-1027486544.png)
ã€€ã€€

æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå›¾æ¥ç»“åˆä¸Šè¿°ç¤ºä¾‹æ¥è§£é‡Šæ …æ çš„å·¥ä½œæ–¹å¼ã€‚ä¸‹å›¾ç”»çš„å°±æ˜¯æ …æ å·¥ä½œçš„æ–¹å¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ‰¹ä»»åŠ¡ä¸­çš„æœ€åä¸€ä¸ªä»»åŠ¡ä¸æ …æ ä¸­çš„ä»»åŠ¡å·²ç»ç¬¬äºŒæ‰¹ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œçš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ …æ èƒ½è¿›è¡Œä»»åŠ¡éš”ç¦»çš„æ ¹æœ¬äº†ã€‚ä»ä¸‹æ–¹çš„å›¾ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œä»»åŠ¡1.3ã€æ …æ ä»»åŠ¡ã€ä»»åŠ¡2.1åœ¨çº¿ç¨‹5ä¸­æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚å…·ä½“è¯·çœ‹ä¸‹å›¾ã€‚
![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160514161629609-1711874945.png)
ã€€ã€€

ä¹ã€dispatch_source

dispatch_sourceåœ¨GCDä¸­æ˜¯ä¸€ä¸ªæ¯”è¾ƒçµæ´»çš„ä¸œè¥¿ï¼ŒåŠŸèƒ½ä¹Ÿæ˜¯éå¸¸å¼ºå¤§çš„ã€‚ç®€å•çš„è¯´ï¼Œdispatch_sourceçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å¯¹æŸäº›ç±»å‹äº‹ä»¶çš„å¯¹è±¡è¿›è¡Œç›‘å¬ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶å°†è¦å¤„ç†çš„äº‹ä»¶æ”¾åˆ°å…³è”çš„é˜Ÿåˆ—ä¸­è¿›è¡Œæ‰§è¡Œã€‚dispatchæºæ”¯æŒäº‹ä»¶çš„å–æ¶ˆï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å–æ¶ˆäº‹ä»¶çš„è¿›è¡Œå¤„ç†ã€‚ä¸‹æ–¹æ˜¯dispatchæºçš„ä¸åŒç±»å‹ï¼Œå› ä¸ºç¯‡å¹…æœ‰é™åœ¨æ­¤å°±ä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ï¼Œå…³äºè¿™äº›ç±»å‹çš„èµ„æ–™ç½‘ä¸Šä¸€æŠ“ä¸€å¤§æŠŠã€‚ä»Šå¤©å°±ä»¥DATA_ADD, DATA_OR, TIMERä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹sourceçš„ä½¿ç”¨æ–¹å¼ã€‚
![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160515161625289-1795649922.png)
ã€€
#### 1.DATA_ADD ä¸DATA_OR

DISPATCH_SOURCE_TYPE_DATA_ADDå’ŒDISPATCH_SOURCE_TYPE_DATA_ORç”¨æ³•å·®ä¸å¤šä¸€ä¸ªæ˜¯å°†æ•°æ®æºè¿›è¡Œç›¸åŠ ï¼Œä¸€ä¸ªæ˜¯è¿›è¡Œæˆ–æ“ä½œã€‚æˆ‘ä»¬å°±ä»¥ç›¸åŠ çš„ä¸ºä¾‹ï¼Œæˆ–æ“ä½œçš„ä»£ç åœ¨åšå®¢ä¸­å°±ä¸ç»™å‡ºäº†ï¼Œä¸è¿‡æˆ‘ä»¬githubä¸Šåˆ†äº«çš„ä»£ç ä¼šæœ‰å®Œæ•´çš„ç¤ºä¾‹ã€‚ä¸‹æ–¹å‡½æ•°æ˜¯DISPATCH_SOURCE_TYPE_DATA_ADDç±»å‹çš„dispatchæºçš„ä½¿ç”¨ã€‚

é¦–å…ˆæˆ‘ä»¬è·å–äº†ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—queueï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªdispatchæºï¼Œå‘½åä¸ºdispatchSourceã€‚åœ¨åˆ›å»ºdispatchæºæ—¶ï¼Œæˆ‘ä»¬ä¸ºdispatchæºæŒ‡å®šäº†ç±»å‹ï¼Œå¹¶ä¸”ä¸ºå…¶å…³è”çš„ä¸€ä¸ªqueueé˜Ÿåˆ—ã€‚å…³è”è¿™ä¸ªé˜Ÿåˆ—çš„ä½œç”¨æ˜¯ç”¨æ¥å¤„ç†dispatchæºä¸­çš„äº‹ä»¶çš„ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨dispatch_source_set_event_handler()ä¸ºæˆ‘ä»¬çš„sourceæŒ‡å®šå¤„ç†äº‹ä»¶ã€‚è¯¥äº‹ä»¶ä¼šåœ¨ä¸€å®šçš„æ¡ä»¶ä¸‹å›è§¦å‘ï¼Œè‡³äºè§¦å‘çš„æ¡ä»¶æœ‰dispatchæºçš„ç±»å‹é”å®šã€‚å› ä¸ºæ­¤å¤„æˆ‘ä»¬dispatchæºçš„ç±»å‹æ˜¯DISPATCH_SOURCE_TYPE_DATA_ADDï¼Œæ‰€ä»¥ä½¿ç”¨dispatch_source_merge_data()å°±å¯ä»¥è§¦å‘ä¸Šé¢æˆ‘ä»¬æŒ‡å®šçš„äº‹ä»¶ã€‚å› ä¸ºdispatchæºåˆ›å»ºåæ˜¯å¤„äºæŒ‚èµ·çš„çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨dispatch_resume()å¯¹æˆ‘ä»¬åˆ›å»ºçš„äº‹ä»¶æºè¿›è¡Œæ¢å¤ã€‚æ¢å¤åçš„dispatchæºæ‰å¯ä»¥ç›‘å¬æ¡ä»¶ä»è€Œè§¦å‘äº‹ä»¶ã€‚

ä¸‹æ–¹ä»£ç æ®µåœ¨forå¾ªç¯ä¸­è°ƒç”¨dispatch_source_merge_data()æ–¹æ³•ã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬è¿˜å¯ä»¥è°ƒç”¨dispatch_source_cancel()å¯¹dispatchæºè¿›è¡Œå–æ¶ˆã€‚å½“dispatch sourceè¢«å–æ¶ˆåï¼Œå°±ä¼šæ‰§è¡Œæˆ‘ä»¬æ‰€è®¾ç½®å–æ¶ˆdispatch_sourceè¦å¤„ç†çš„äº‹ä»¶ã€‚æˆ‘ä»¬é€šè¿‡dispatch_source_set_candel_handel()æ¥æŒ‡å®šå–æ¶ˆdispatch sourceè¦æ‰§è¡Œçš„äº‹ä»¶ã€‚å…³äºdispatch_sourceçš„å–æ¶ˆï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹é¢å€’è®¡æ—¶çš„æ—¶å€™ç»™å‡ºã€‚

æˆ‘ä»¬æ­¤å¤„åˆ›å»ºçš„dispatch_sourceçš„ç±»å‹æ˜¯Data Addç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬æŒ‡å®šçš„æºäº‹ä»¶æœªå¤„ç†å®Œæ—¶ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªDataå°±è¦è¿›è¡Œç­‰å¾…ã€‚è€Œç­‰å¾…çš„æ•°æ®ä¼šé€šè¿‡dispatch_source_merge_data()æ–¹æ³•è¿›è¡Œåˆå¹¶ã€‚å¦‚æœä½ åˆ›å»ºçš„æ˜¯DISPATCH_SOURCE_TYPE_DATA_ADDç±»å‹çš„dispatch_sourceï¼Œé‚£ä¹ˆå°±ä¼šæŒ‰ç…§åŠ æ³•è¿›è¡Œåˆå¹¶ã€‚å¦‚æœä½ æ˜¯åˆ›å»ºçš„DISPATCH_SOURCE_TYPE_DATA_ORç±»å‹çš„dispatch_source, é‚£ä¹ˆå°±ä¼šé€šè¿‡æˆ–è¿ç®—è¿›è¡Œåˆå¹¶ã€‚åˆå¹¶åœ¨ä¸€èµ·çš„æ•°æ®ä¼šä¸€åŒè§¦å‘æˆ‘ä»¬è®¾å®šçš„äº‹ä»¶ã€‚
```Swift
/**
 ä»¥åŠ æ³•è¿ç®—çš„æ–¹å¼åˆå¹¶æ•°æ®
 */
func useDispatchSourceAdd() {
    var sum = 0     //æ‰‹åŠ¨è®¡æ•°çš„sum, æ¥æ¨¡æ‹Ÿè®°å½•mergeçš„æ•°æ®
    
    let queue = getGlobalQueue()
    
    //åˆ›å»ºsource
    let dispatchSource:DispatchSource = DispatchSource.makeUserDataAddSource(queue: queue) as! DispatchSource
    
    dispatchSource.setEventHandler {
//        print("sourceä¸­æ‰€æœ‰çš„æ•°ç›¸åŠ çš„å’Œç­‰äº\(dispatchSource.Date)")
        print("sum = \(sum)\n")
        sum = 0
       currentThreadSleep(0.3)
    }

    dispatchSource.resume()
    
    for i in 1...10 {
        sum += i
        print(i)
//        dispatchSource.mergeData(value: UInt(i))
        currentThreadSleep(0.1)
    }
}

```
ã€€ã€€

ä¸Šè¿°ä»£ç æ®µå°±æ˜¯å¯¹DATA_ADDç±»çš„çš„dispatchæºè¿›è¡Œçš„æµ‹è¯•ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå˜é‡sumæ¥æ¨¡æ‹Ÿæ•°æ®çš„åˆå¹¶ï¼Œç„¶åè§‚å¯Ÿæ¯æ¬¡åˆå¹¶çš„æ•°æ®ä¸æˆ‘ä»¬è‡ªå®šçš„sumä¸­è®¡ç®—çš„æ•°æ®æ˜¯å¦ç›¸åŒã€‚åˆå¹¶åæ¯æ¬¡æ‰§è¡Œä¸€æ¬¡äº‹ä»¶æˆ‘ä»¬éƒ½å°†sumè¿›è¡Œå½’é›¶ï¼Œç„¶åè¿›è¡Œä¸‹ä¸€è½®çš„åˆå¹¶ã€‚ä¸‹æ–¹å°±æ˜¯ä¸Šè¿°ä»£ç è¾“å‡ºçš„ç»“æœã€‚ä»ä¸‹æ–¹çš„ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨ä¸Šè¿°çš„10æ¬¡å¾ªç¯ä¸­æ‰§è¡Œäº†å››æ¬¡æˆ‘ä»¬æŒ‡å®šçš„sourceäº‹ä»¶ï¼Œè€Œä¸”æ¯æ¬¡æ‰§è¡Œäº‹ä»¶æ‰€mergeçš„Dataä¸æˆ‘ä»¬æ‰‹åŠ¨è®°å½•çš„sumä¸€è‡´ã€‚è¿™å°±æ˜¯DATA_ADDçš„å·¥ä½œæ–¹å¼ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚å…³äºData_Orçš„è¿è¡Œæ–¹å¼åœ¨æ­¤å°±ä¸åšè¿‡å¤šçš„èµ˜è¿°äº†ã€‚
![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160515212302148-661453011.png)
ã€€ã€€

 

#### 2.å®šæ—¶å™¨

åœ¨GCDçš„dispatchæºä¸­è¿˜æœ‰å®šæ—¶å™¨ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå®šæ—¶å™¨ç±»å‹çš„dispatchæºï¼Œç„¶åé€šè¿‡dispatch_source_set_event_handler()æ¥è®¾å®šæºäº‹ä»¶ã€‚ç„¶åé€šè¿‡dispatch_source_set_timer()å‡½æ•°æ¥ä¸ºå®šæ—¶å™¨ç±»å‹çš„dispatch_sourceæŒ‡å®šæ—¶é—´é—´éš”ï¼Œè¯¥å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯dispatch sourceï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯è§¦å‘äº‹ä»¶çš„æ—¶é—´é—´éš”ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯å…è®¸è¯¯å·®çš„æ—¶é—´ã€‚å½“æˆ‘ä»¬è®¾å®šçš„å€’è®¡æ—¶çš„æ¬¡æ•°åˆ°æ˜¯ï¼Œæˆ‘ä»¬å°±è°ƒç”¨dispatch_source_cancel()æ¥è¿›è¡Œdispatch_sourceçš„å–æ¶ˆï¼Œå½“å–æ¶ˆåå°±ä¼šæ‰§è¡Œdispatch_source_set_cancel_handel()æ–¹æ³•ä¸­çš„å°¾éšé—­åŒ…ã€‚

ä¸‹æ–¹ç¤ºä¾‹æ˜¯ä½¿ç”¨DISPATCH_SOURCE_TYPE_TIMERç±»å‹çš„dispatch sourceè¿›è¡Œçš„10ç§’åˆ°è®¡æ—¶ï¼Œç­‰æˆ‘ä»¬è®¾ç½®çš„äº‹ä»¶æ‰§è¡Œ10æ¬¡åæˆ‘ä»¬å°±å–æ¶ˆdispatch_sourceã€‚å¯¹äºä¸‹æ–¹çš„ç¤ºä¾‹æ¥è¯´ï¼Œå½“dispatch sourceé€šè¿‡dispatch_resume()å‡½æ•°è¿›è¡Œå”¤é†’åï¼Œä¼šå¼€å§‹å€’è®¡æ—¶ã€‚ä¼šåœ¨å€’è®¡æ—¶10ç§’åç»“æŸè®¡æ—¶ã€‚
```Swift
/**
 ä½¿ç”¨dispatch_sourceåˆ›å»ºå®šæ—¶å™¨
 */
func useDispatchSourceTimer() {
    let queue: DispatchQueue = getGlobalQueue()
    let source = DispatchSource.makeTimerSource(flags: DispatchSource.TimerFlags(rawValue: 0), queue: queue)
   
    //è®¾ç½®é—´éš”æ—¶é—´ï¼Œä»å½“å‰æ—¶é—´å¼€å§‹ï¼Œå…è®¸åå·®0çº³ç§’
    let timer = UInt64(1) * NSEC_PER_SEC
    source.scheduleRepeating(deadline: DispatchTime.init(uptimeNanoseconds: UInt64(timer)), interval: DispatchTimeInterval.seconds(Int(1)), leeway: DispatchTimeInterval.seconds(0))
    
    var timeout = 10    //å€’è®¡æ—¶æ—¶é—´
    
    //è®¾ç½®è¦å¤„ç†çš„äº‹ä»¶, åœ¨æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„queueé˜Ÿåˆ—ä¸­è¿›è¡Œæ‰§è¡Œ
    source.setEventHandler {
        print(getCurrentThread())
        if(timeout <= 0) {
            source.cancel()
        } else {
            print("\(timeout)s")
            timeout -= 1
        }
    }
    
    //å€’è®¡æ—¶ç»“æŸçš„äº‹ä»¶
    source.setCancelHandler { 
        print("å€’è®¡æ—¶ç»“æŸ")
    }
    source.resume()
}

```
ã€€ã€€

 

ä¸‹æ–¹å°±æ˜¯ä¸Šè¿°å€’è®¡æ—¶ä»£ç æ‰€æ‰§è¡Œåçš„ç»“æœã€‚ä»è¿è¡Œç»“æœä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œå½“å€’è®¡æ—¶å¼€å§‹æ—¶ï¼Œä¼šæ–°å¼€è¾Ÿä¸€äº›æ–°çš„çº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œå€’è®¡æ—¶ä»»åŠ¡ã€‚å°½ç®¡ä½ ä½¿ç”¨çš„æ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œè™½ç„¶æ¯æ¬¡å¼€è¾Ÿçš„çº¿ç¨‹å¯èƒ½ä¼šä¸åŒï¼Œä½†æ˜¯éƒ½ä¼šé¡ºåºçš„æ‰§è¡Œå€’è®¡æ—¶ä»»åŠ¡.

![](http://images2015.cnblogs.com/blog/545446/201605/545446-20160515213807055-720183647.png)
ã€€ã€€
